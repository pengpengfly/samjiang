

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>访问日志 &mdash; envoy 1.16.0-2d66f8 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/envoy.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/sphinx_tabs/semantic-ui-2.4.1/segment.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/sphinx_tabs/semantic-ui-2.4.1/menu.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/sphinx_tabs/semantic-ui-2.4.1/tab.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/sphinx_tabs/tabs.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/copybutton.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
        <script src="../../../_static/clipboard.min.js"></script>
        <script src="../../../_static/copybutton.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="安全" href="../../security/security.html" />
    <link rel="prev" title="统计" href="stats.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html">
          

          
            
            <img src="../../../_static/envoy-logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                1.16.0-2d66f8
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../about_docs.html">关于文档</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../intro/intro.html">介绍</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../start/start.html">开始</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../install/install.html">构建和安装</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../version_history/version_history.html">Version history</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../configuration.html">配置参考</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../overview/overview.html">概览</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../listeners/listeners.html">监听器</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../http/http.html">HTTP</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../upstream/upstream.html">上游集群</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../observability.html">可观测性</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../statistics.html">统计</a></li>
<li class="toctree-l3"><a class="reference internal" href="../application_logging.html">Application logging</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="access_log.html">访问日志</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="overview.html">概览</a></li>
<li class="toctree-l4"><a class="reference internal" href="stats.html">统计</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">访问日志</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../security/security.html">安全</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../operations/operations.html">操作</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../other_features/other_features.html">其他特性</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../other_protocols/other_protocols.html">其他协议</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../advanced/advanced.html">高级配置</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../best_practices/best_practices.html">配置最佳实践</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../operations/operations.html">Operations and administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../extending/extending.html">Extending Envoy for custom use cases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/api.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/overview.html">FAQ</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">envoy</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../configuration.html">配置参考</a> &raquo;</li>
        
          <li><a href="../observability.html">可观测性</a> &raquo;</li>
        
          <li><a href="access_log.html">访问日志</a> &raquo;</li>
        
      <li>访问日志</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../_sources/configuration/observability/access_log/usage.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="config-access-log">
<span id="id1"></span><h1>访问日志<a class="headerlink" href="#config-access-log" title="Permalink to this headline">¶</a></h1>
<div class="section" id="id2">
<h2>配置<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p>访问日志是 <a class="reference internal" href="../../http/http_conn_man/http_conn_man.html#config-http-conn-man"><span class="std std-ref">HTTP 连接管理器配置</span></a> 或 <a class="reference internal" href="../../listeners/network_filters/tcp_proxy_filter.html#config-network-filters-tcp-proxy"><span class="std std-ref">TCP 代理配置</span></a> 配置的一部分。</p>
<ul class="simple">
<li><p><a class="reference internal" href="../../../api-v3/config/accesslog/v3/accesslog.proto.html#envoy-v3-api-msg-config-accesslog-v3-accesslog"><span class="std std-ref">v3 API 参考</span></a></p></li>
</ul>
</div>
<div class="section" id="config-access-log-format">
<span id="id3"></span><h2>格式规则<a class="headerlink" href="#config-access-log-format" title="Permalink to this headline">¶</a></h2>
<p>访问日志格式包含用于提取和插入有关数据的命令操作符。
他们支持两种格式: <a class="reference internal" href="#config-access-log-format-strings"><span class="std std-ref">“格式字符串”</span></a> 和
<a class="reference internal" href="#config-access-log-format-dictionaries"><span class="std std-ref">“格式词典”</span></a>。两种情况下，命令操作符
用于提取那些随后将被插入到特定日志格式中的有关数据。
一次只能指定一种访问日志格式。</p>
</div>
<div class="section" id="config-access-log-format-strings">
<span id="id4"></span><h2>格式字符串<a class="headerlink" href="#config-access-log-format-strings" title="Permalink to this headline">¶</a></h2>
<p>格式字符串是使用关键字 <code class="docutils literal notranslate"><span class="pre">format</span></code> 描述的纯字符串。他们可能包含命令操作符或者是其他被解释成纯字符串的字符
访问日志格式化器不假设新的行分隔符，因此必须将其指定为格式字符串的一部分。
例如 <a class="reference internal" href="#config-access-log-default-format"><span class="std std-ref">默认格式</span></a>。</p>
</div>
<div class="section" id="config-access-log-default-format">
<span id="id5"></span><h2>默认格式<a class="headerlink" href="#config-access-log-default-format" title="Permalink to this headline">¶</a></h2>
<p>如果自定义格式未指定，Envoy 使用如下的默认格式:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[%START_TIME%] &quot;%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%&quot;
%RESPONSE_CODE% %RESPONSE_FLAGS% %BYTES_RECEIVED% %BYTES_SENT% %DURATION%
%RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)% &quot;%REQ(X-FORWARDED-FOR)%&quot; &quot;%REQ(USER-AGENT)%&quot;
&quot;%REQ(X-REQUEST-ID)%&quot; &quot;%REQ(:AUTHORITY)%&quot; &quot;%UPSTREAM_HOST%&quot;\n
</pre></div>
</div>
<p>默认 Envoy 访问日志格式举例:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[2016-04-15T20:17:00.310Z] &quot;POST /api/v1/locations HTTP/2&quot; 204 - 154 0 226 100 &quot;10.0.35.28&quot;
&quot;nsq2http&quot; &quot;cc21d9b0-cf5c-432b-8c7e-98aeb7988cd2&quot; &quot;locations&quot; &quot;tcp://10.0.2.1:80&quot;
</pre></div>
</div>
</div>
<div class="section" id="config-access-log-format-dictionaries">
<span id="id6"></span><h2>格式词典<a class="headerlink" href="#config-access-log-format-dictionaries" title="Permalink to this headline">¶</a></h2>
<p>格式词典是指定结构化访问日志输出格式的词典，通过 <code class="docutils literal notranslate"><span class="pre">json_format</span></code> 或者 <code class="docutils literal notranslate"><span class="pre">typed_json_format</span></code> 关键字指定。
允许日志被输出到结构化的格式中（如 JSON）。和格式字符串类似，命令操作符被解析并将其值插入到用于构造日志输出的格式词典中。</p>
<p>如下给出了一个 <code class="docutils literal notranslate"><span class="pre">json_format</span></code> 配置的示例:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;config&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;json_format&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;protocol&quot;</span><span class="p">:</span> <span class="s2">&quot;%PROTOCOL%&quot;</span><span class="p">,</span>
        <span class="nt">&quot;duration&quot;</span><span class="p">:</span> <span class="s2">&quot;%DURATION%&quot;</span><span class="p">,</span>
        <span class="nt">&quot;my_custom_header&quot;</span><span class="p">:</span> <span class="s2">&quot;%REQ(MY_CUSTOM_HEADER)%&quot;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>与此对应，下面的 JSON 对象会被写入到日志文件中：</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="nt">&quot;protocol&quot;</span><span class="p">:</span> <span class="s2">&quot;HTTP/1.1&quot;</span><span class="p">,</span> <span class="nt">&quot;duration&quot;</span><span class="p">:</span> <span class="s2">&quot;123&quot;</span><span class="p">,</span> <span class="nt">&quot;my_custom_header&quot;</span><span class="p">:</span> <span class="s2">&quot;value_of_MY_CUSTOM_HEADER&quot;</span><span class="p">}</span>
</pre></div>
</div>
<p>每个命令操作符允许指定一个自定义关键字。</p>
<p><code class="docutils literal notranslate"><span class="pre">typed_json_format</span></code> 不同于 <code class="docutils literal notranslate"><span class="pre">json_format</span></code> ，它的值会被渲染成合适的 JSON 数字、布尔和嵌套对象或列表。
在例子中，请求持续时间会被渲染成一个数字 <code class="docutils literal notranslate"><span class="pre">123</span></code>。</p>
<p>格式词典有如下限制：</p>
<ul class="simple">
<li><p>词典必须是字符串到字符串的映射（具体来说，是字符串到命令操作符）。支持嵌套。</p></li>
<li><p>当使用 <code class="docutils literal notranslate"><span class="pre">typed_json_format</span></code> 命令操作符时，如果命令操作符是出现在词典值域中的唯一字符串会产生确定类型输出。例如，
<code class="docutils literal notranslate"><span class="pre">&quot;%DURATION%&quot;</span></code> 会记录成一个持续值的数值，但是 <code class="docutils literal notranslate"><span class="pre">&quot;%DURATION%.0&quot;</span></code> 会记录成一个字符串。</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>当使用 <code class="docutils literal notranslate"><span class="pre">typed_json_format</span></code> 时，超过 <span class="math notranslate nohighlight">\(2^{53}\)</span> 的整数，由于需要转换成浮点数因此会使精度降低。</p>
</div>
</div>
<div class="section" id="config-access-log-command-operators">
<span id="id7"></span><h2>命令运算符<a class="headerlink" href="#config-access-log-command-operators" title="Permalink to this headline">¶</a></h2>
<p>命令运算符用于提取那些将被插入到访问日志中值。
相同的运算符在不同类型的访问日志（例如 HTTP 和 TCP）中用处不同。 不同日志类型中有些字段可能有细微的差别。 注意不同点。</p>
<p>注意如果一个值未设置或为空，日志将会包含一个 <code class="docutils literal notranslate"><span class="pre">-</span></code> 或者 JSON 日志中的字符串 <code class="docutils literal notranslate"><span class="pre">&quot;-&quot;</span></code>。
对于有类型的 JSON 日志来说，为设置的值会被表示成 <code class="docutils literal notranslate"><span class="pre">null</span></code> 值，并且空字符串会被渲染成 <code class="docutils literal notranslate"><span class="pre">&quot;&quot;</span></code> <a class="reference internal" href="../../../api-v3/config/core/v3/substitution_format_string.proto.html#envoy-v3-api-field-config-core-v3-substitutionformatstring-omit-empty-values"><span class="std std-ref">omit_empty_values</span></a> 选项可用于完全忽略空值。</p>
<p>除非另有说明，命令操作符生成针对 JSON 日志的字符串输出。</p>
<p>支持如下命令操作符：</p>
<dl id="config-access-log-format-start-time">
<dt>%START_TIME%</dt><dd><dl class="simple">
<dt>HTTP</dt><dd><p>请求开始时间（包括毫秒）。</p>
</dd>
<dt>TCP</dt><dd><p>下游连接开始时间（包括毫秒）。</p>
</dd>
</dl>
<p>START_TIME 可以通过 <a class="reference external" href="https://en.cppreference.com/w/cpp/io/manip/put_time">format string</a> 自定义。
除此之外, START_TIME 也允许如下格式符：</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 28%" />
<col style="width: 72%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>格式符</p></th>
<th class="head"><p>说明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">%s</span></code></p></td>
<td><p>从 1970-01-01 00:00:00 UTC 开始的秒数</p></td>
</tr>
<tr class="row-odd"><td rowspan="2"><p><code class="docutils literal notranslate"><span class="pre">%f</span></code>, <code class="docutils literal notranslate"><span class="pre">%[1-9]f</span></code></p></td>
<td><p>小数秒位数，默认 9 位 (纳秒)</p></td>
</tr>
<tr class="row-even"><td><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">%3f</span></code> 毫秒 (3 位)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">%6f</span></code> 微秒 (6 位)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">%9f</span></code> 纳秒 (9 位)</p></li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>如下是 START_TIME 格式的举例：</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>%START_TIME(%Y/%m/%dT%H:%M:%S%z %s)%

# To include millisecond fraction of the second (.000 ... .999). E.g. 1527590590.528.
%START_TIME(%s.%3f)%

%START_TIME(%s.%6f)%

%START_TIME(%s.%9f)%
</pre></div>
</div>
<p>在确定类型的 JSON 日志中，START_TIME 通常被渲染成字符串。</p>
</dd>
<dt>%BYTES_RECEIVED%</dt><dd><dl class="simple">
<dt>HTTP</dt><dd><p>接收到消息体字节数。</p>
</dd>
<dt>TCP</dt><dd><p>在连接上从下游接收的字节数。</p>
</dd>
</dl>
<p>在确定类型的 JSON 日志中，渲染成一个数值类型。</p>
</dd>
<dt>%PROTOCOL%</dt><dd><dl class="simple">
<dt>HTTP</dt><dd><p>协议。目前不是 <em>HTTP/1.1</em> 就是 <em>HTTP/2</em>。</p>
</dd>
<dt>TCP</dt><dd><p>未实现 (“-“)。</p>
</dd>
</dl>
<p>在确定类型的 JSON 日志中，PROTOCOL 会被渲染成字符串。如果协议不可用(如： 在 TCP 日志中) 为 <code class="docutils literal notranslate"><span class="pre">&quot;-&quot;</span></code> 。</p>
</dd>
<dt>%RESPONSE_CODE%</dt><dd><dl class="simple">
<dt>HTTP</dt><dd><p>HTTP 响应码。注意响应码 ‘0’ 表示服务器从未发送过响应数据。 通常认为是（下游）客户端断开。</p>
</dd>
<dt>TCP</dt><dd><p>未实现 (“-“)。</p>
</dd>
</dl>
<p>在确定类型的 JSON 日志中，渲染成一个数值类型。</p>
</dd>
</dl>
<dl class="simple" id="config-access-log-format-response-code-details">
<dt>%RESPONSE_CODE_DETAILS%</dt><dd><dl class="simple">
<dt>HTTP</dt><dd><p>HTTP 响应状态码详情提供关于响应状态码的附加信息， 例如谁设置了它 (上游 或者 envoy) 和原因。</p>
</dd>
<dt>TCP</dt><dd><p>未实现 (“-“)</p>
</dd>
</dl>
</dd>
</dl>
<dl id="config-access-log-format-connection-termination-details">
<dt>%CONNECTION_TERMINATION_DETAILS%</dt><dd><dl class="simple">
<dt>HTTP 和 TCP</dt><dd><p>连接中断详情会提供和连接被 Envoy 在 L4 中断原因相关的的附加信息。</p>
</dd>
</dl>
</dd>
<dt>%BYTES_SENT%</dt><dd><dl class="simple">
<dt>HTTP</dt><dd><p>发送的包体字节数。 对于 WebSocket 连接将会包含响应头字节数。</p>
</dd>
<dt>TCP</dt><dd><p>在连接上发送给下游的字节数。</p>
</dd>
</dl>
<p>在确定类型的 JSON 日志中，渲染成一个数值类型。</p>
</dd>
<dt>%DURATION%</dt><dd><dl class="simple">
<dt>HTTP</dt><dd><p>请求从起始时间到最后一个字节发出的持续总时长（以毫秒为单位）。</p>
</dd>
<dt>TCP</dt><dd><p>下游连接的持续总时长（以毫秒为单位）。</p>
</dd>
</dl>
<p>在确定类型的 JSON 日志中，渲染成一个数值类型。</p>
</dd>
<dt>%REQUEST_DURATION%</dt><dd><dl class="simple">
<dt>HTTP</dt><dd><p>请求从起始时间到接收完下游的最后一个字节为止的持续总时长（以毫秒为单位）。</p>
</dd>
<dt>TCP</dt><dd><p>未实现 (“-“)。</p>
</dd>
</dl>
<p>在确定类型的 JSON 日志中，渲染成一个数值类型。</p>
</dd>
<dt>%RESPONSE_DURATION%</dt><dd><dl class="simple">
<dt>HTTP</dt><dd><p>请求从起始时间直到上游的第一个字节到达为止的持续总时长（以毫秒为单位）。</p>
</dd>
<dt>TCP</dt><dd><p>未实现 (“-“)。</p>
</dd>
</dl>
<p>在确定类型的 JSON 日志中，渲染成一个数值类型。</p>
</dd>
<dt>%RESPONSE_TX_DURATION%</dt><dd><dl class="simple">
<dt>HTTP</dt><dd><p>请求从读第一个来自于上游主机的字节开始到给下游发完最后一个字节的持续时常（以毫秒为单位）。</p>
</dd>
<dt>TCP</dt><dd><p>未实现 (“-“)。</p>
</dd>
</dl>
<p>在确定类型的 JSON 日志中，渲染成一个数值类型。</p>
</dd>
</dl>
<dl id="config-access-log-format-response-flags">
<dt>%RESPONSE_FLAGS%</dt><dd><p>如果有的话，表示响应或者连接的附加详情。 对于 TCP 连接，说明中提到的响应码不适用。 可能的值如下：</p>
<dl class="simple">
<dt>HTTP 和 TCP</dt><dd><ul class="simple">
<li><p><strong>UH</strong>: 附加在 503 响应状态码，表示上游集群中无健康的上游主机。</p></li>
<li><p><strong>UF</strong>: 附加在 503 响应状态码，表示上游连接失败。</p></li>
<li><p><strong>UO</strong>: 附加在 503 响应状态码，表示上游溢出 (<a class="reference internal" href="../../../intro/arch_overview/upstream/circuit_breaking.html#arch-overview-circuit-break"><span class="std std-ref">熔断</span></a>) 。</p></li>
<li><p><strong>NR</strong>: 附加在 404 响应状态码，表示无给定请求的 <a class="reference internal" href="../../../intro/arch_overview/http/http_routing.html#arch-overview-http-routing"><span class="std std-ref">路由配置</span></a> ，或者对于一个下游连接没有匹配的过滤器链。</p></li>
<li><p><strong>URX</strong>: 请求因为达到了 <a class="reference internal" href="../../../api-v3/config/route/v3/route_components.proto.html#envoy-v3-api-field-config-route-v3-retrypolicy-num-retries"><span class="std std-ref">上游重试限制 (HTTP)</span></a>  或者 <a class="reference internal" href="../../../api-v3/extensions/filters/network/tcp_proxy/v3/tcp_proxy.proto.html#envoy-v3-api-field-extensions-filters-network-tcp-proxy-v3-tcpproxy-max-connect-attempts"><span class="std std-ref">最大连接尝试 (TCP)</span></a> 而被拒绝。</p></li>
</ul>
</dd>
<dt>HTTP 独有</dt><dd><ul class="simple">
<li><p><strong>DC</strong>: 下游连接中断。</p></li>
<li><p><strong>LH</strong>: 附加在 503 响应状态码，本地服务 <a class="reference internal" href="../../../intro/arch_overview/upstream/health_checking.html#arch-overview-health-checking"><span class="std std-ref">健康检查请求</span></a> 失败。</p></li>
<li><p><strong>UT</strong>: 附加在 504 响应状态码，上游请求超时。</p></li>
<li><p><strong>LR</strong>: 附加在 503 响应状态码，连接在本地被重置。</p></li>
<li><p><strong>UR</strong>: 附加在 503 响应状态码，连接在远程被重置。</p></li>
<li><p><strong>UC</strong>: 附加在 503 响应状态码，上游连接中断。</p></li>
<li><p><strong>DI</strong>: 通过 <a class="reference internal" href="../../http/http_filters/fault_filter.html#config-http-filters-fault-injection"><span class="std std-ref">故障注入</span></a> 使请求处理被延迟一个指定的时间。</p></li>
<li><p><strong>FI</strong>: 通过 <a class="reference internal" href="../../http/http_filters/fault_filter.html#config-http-filters-fault-injection"><span class="std std-ref">故障注入</span></a> 使请求被终止掉并带有一个相应码。</p></li>
<li><p><strong>RL</strong>: 附加在 429 相应状态码，请求被 <a class="reference internal" href="../../http/http_filters/rate_limit_filter.html#config-http-filters-rate-limit"><span class="std std-ref">HTTP 限流过滤器</span></a> 本地限流。</p></li>
<li><p><strong>UAEX</strong>: 请求被外部授权服务拒绝。</p></li>
<li><p><strong>RLSE</strong>: 因限流服务出现错误而拒绝请求。</p></li>
<li><p><strong>IH</strong>: 附加在 400 响应状态码，请求被拒绝因为他为
<a class="reference internal" href="../../../api-v3/extensions/filters/http/router/v3/router.proto.html#envoy-v3-api-field-extensions-filters-http-router-v3-router-strict-check-headers"><span class="std std-ref">strictly-checked header</span></a> 设置了一个无效值。</p></li>
<li><p><strong>SI</strong>: 附加在 408 相应状态码，流闲置超时。</p></li>
<li><p><strong>DPE</strong>: 下游请求存在一个 HTTP 协议错误。</p></li>
<li><p><strong>UMSDR</strong>: 上游请求达到最大流持续时长。</p></li>
</ul>
</dd>
</dl>
</dd>
<dt>%ROUTE_NAME%</dt><dd><p>路由名。</p>
</dd>
<dt>%UPSTREAM_HOST%</dt><dd><p>上游主机 URL（如，TCP 连接 <a class="reference external" href="tcp://ip:port">tcp://ip:port</a>）。</p>
</dd>
<dt>%UPSTREAM_CLUSTER%</dt><dd><p>上游主机所属的上游集群。</p>
</dd>
<dt>%UPSTREAM_LOCAL_ADDRESS%</dt><dd><p>上游连接的本地地址。如果地址是 IP 地址，则会包含地址和端口。</p>
</dd>
</dl>
<dl id="config-access-log-format-upstream-transport-failure-reason">
<dt>%UPSTREAM_TRANSPORT_FAILURE_REASON%</dt><dd><dl class="simple">
<dt>HTTP</dt><dd><p>如果上游因传输套接字（例如 TLS 握手）而连接失败，从传输套接字中提供失败原因。 这个字段的格式依赖于上游传输套接字的配置。
公共的 TLS 失败在 <a class="reference internal" href="../../../intro/arch_overview/security/ssl.html#arch-overview-ssl-trouble-shooting"><span class="std std-ref">TLS 故障排除</span></a>。</p>
</dd>
<dt>TCP</dt><dd><p>未实现 (“-“)。</p>
</dd>
</dl>
</dd>
<dt>%DOWNSTREAM_REMOTE_ADDRESS%</dt><dd><p>下游连接的远程地址。如果地址是 IP 地址，它会包含地址和端口。</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>如果地址是从 <a class="reference internal" href="../../../api-v3/config/listener/v3/listener_components.proto.html#envoy-v3-api-field-config-listener-v3-filterchain-use-proxy-proto"><span class="std std-ref">proxy proto</span></a> 或 <a class="reference internal" href="../../http/http_conn_man/headers.html#config-http-conn-man-headers-x-forwarded-for"><span class="std std-ref">x-forwarded-for</span></a> 推断而来，则可能不是对端的物理远程地址。</p>
</div>
</dd>
<dt>%DOWNSTREAM_REMOTE_ADDRESS_WITHOUT_PORT%</dt><dd><p>下游连接的远程地址。如果地址是 IP 地址，它 <em>不</em> 包含端口。</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>如果地址是从 <a class="reference internal" href="../../../api-v3/config/listener/v3/listener_components.proto.html#envoy-v3-api-field-config-listener-v3-filterchain-use-proxy-proto"><span class="std std-ref">proxy proto</span></a> 或 <a class="reference internal" href="../../http/http_conn_man/headers.html#config-http-conn-man-headers-x-forwarded-for"><span class="std std-ref">x-forwarded-for</span></a> 推断而来，则可能不是对端的物理远程地址。</p>
</div>
</dd>
<dt>%DOWNSTREAM_DIRECT_REMOTE_ADDRESS%</dt><dd><p>下游连接的直达远程地址。如果地址是 IP 地址，它会包含地址和端口。</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>通常是对端的物理远程地址，即使上游远程地址是从 <a class="reference internal" href="../../../api-v3/config/listener/v3/listener_components.proto.html#envoy-v3-api-field-config-listener-v3-filterchain-use-proxy-proto"><span class="std std-ref">proxy proto</span></a>
或 <a class="reference internal" href="../../http/http_conn_man/headers.html#config-http-conn-man-headers-x-forwarded-for"><span class="std std-ref">x-forwarded-for</span></a> 推断而来。</p>
</div>
</dd>
<dt>%DOWNSTREAM_DIRECT_REMOTE_ADDRESS_WITHOUT_PORT%</dt><dd><p>下游连接的直达远程地址。如果地址是 IP 地址，它*不*包含端口。</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>通常是对端的物理远程地址，即使上游远程地址是从 <a class="reference internal" href="../../../api-v3/config/listener/v3/listener_components.proto.html#envoy-v3-api-field-config-listener-v3-filterchain-use-proxy-proto"><span class="std std-ref">proxy proto</span></a>
或 <a class="reference internal" href="../../http/http_conn_man/headers.html#config-http-conn-man-headers-x-forwarded-for"><span class="std std-ref">x-forwarded-for</span></a> 推断而来。</p>
</div>
</dd>
<dt>%DOWNSTREAM_LOCAL_ADDRESS%</dt><dd><p>下游连接的本地地址。如果地址是 IP 地址，它会包含地址和端口。
如果原始连接被 iptables 的 REDIRECT 重定向，则代表通过 <a class="reference internal" href="../../listeners/listener_filters/original_dst_filter.html#config-listener-filters-original-dst"><span class="std std-ref">原始目的过滤器</span></a>
经过 SO_ORIGINAL_DST 套接字选项重存的原始目的地址。
如果原始连接被 iptables 的 TPROXY 重定向，并且监听器的 transparent 选项设置为 true，则代表原始的目的地地址和端口。</p>
</dd>
<dt>%DOWNSTREAM_LOCAL_ADDRESS_WITHOUT_PORT%</dt><dd><p>与 <strong>%DOWNSTREAM_LOCAL_ADDRESS%</strong> 相同，如果是IP地址不包含端口。</p>
</dd>
</dl>
<dl id="config-access-log-format-connection-id">
<dt>%CONNECTION_ID%</dt><dd><p>下游连接的标识。它可以用于交叉引用跨多个日志汇聚的 TCP 访问日志， 或者对同一个连接交叉引用基于时间的报告。
标识在一个执行程序中大概率是是唯一的，但是在多个实例或者重启实例间可以重复。</p>
</dd>
<dt>%GRPC_STATUS%</dt><dd><p>gRPC 状态码，易于用数字对应的消息进行翻译</p>
</dd>
<dt>%DOWNSTREAM_LOCAL_PORT%</dt><dd><p>类似 <strong>%DOWNSTREAM_LOCAL_ADDRESS_WITHOUT_PORT%</strong>，但是只提取 <strong>%DOWNSTREAM_LOCAL_ADDRESS%</strong> 的端口部分。</p>
</dd>
<dt>%REQ(X?Y):Z%</dt><dd><dl class="simple">
<dt>HTTP</dt><dd><p>HTTP 请求头，其中 X 是首选的 HTTP 头，Y 是一个替代值，Z 是一个可选参数表示字符串截断至 Z 字符长。
其值首先从名字为 X 的 HTTP 请求头获取，如果其未设置，那么使用请求头 Y。如果请求头均是 none，则在日志中表示成 ‘-‘ 符号。</p>
</dd>
<dt>TCP</dt><dd><p>未实现 (“-“)。</p>
</dd>
</dl>
</dd>
<dt>%RESP(X?Y):Z%</dt><dd><dl class="simple">
<dt>HTTP</dt><dd><p>除了从 HTTP 响应头中获取以外，其他和 <strong>%REQ(X?Y):Z%</strong> 相同。</p>
</dd>
<dt>TCP</dt><dd><p>未实现 (“-“)。</p>
</dd>
</dl>
</dd>
<dt>%TRAILER(X?Y):Z%</dt><dd><dl class="simple">
<dt>HTTP</dt><dd><p>除了从 HTTP 响应尾中获取以外，其他和 <strong>%REQ(X?Y):Z%</strong> 相同。</p>
</dd>
<dt>TCP</dt><dd><p>未实现 (“-“)。</p>
</dd>
</dl>
</dd>
<dt>%DYNAMIC_METADATA(NAMESPACE:KEY*):Z%</dt><dd><dl>
<dt>HTTP</dt><dd><p><a class="reference internal" href="../../../api-v3/config/core/v3/base.proto.html#envoy-v3-api-msg-config-core-v3-metadata"><span class="std std-ref">动态元数据</span></a> 信息，
当设置元信息时 NAMESPACE 是过滤命名空间的过滤器器，KEY 是命名空间内可选查找关键字，可以被可选嵌套关键字 ‘:’ 切分，
Z 是一个可选参数表示字符串截断至 Z 字符长。动态元数据可以被过滤器用:repo:<cite>StreamInfo &lt;include/envoy/stream_info/stream_info.h&gt;</cite> API:
<em>setDynamicMetadata</em> 设置。数据会被记录成 JSON 字符串。如下动态参数：</p>
<p><code class="docutils literal notranslate"><span class="pre">com.test.my_filter:</span> <span class="pre">{&quot;test_key&quot;:</span> <span class="pre">&quot;foo&quot;,</span> <span class="pre">&quot;test_object&quot;:</span> <span class="pre">{&quot;inner_key&quot;:</span> <span class="pre">&quot;bar&quot;}}</span></code></p>
<ul class="simple">
<li><p>%DYNAMIC_METADATA(com.test.my_filter)% will log: <code class="docutils literal notranslate"><span class="pre">{&quot;test_key&quot;:</span> <span class="pre">&quot;foo&quot;,</span> <span class="pre">&quot;test_object&quot;:</span> <span class="pre">{&quot;inner_key&quot;:</span> <span class="pre">&quot;bar&quot;}}</span></code></p></li>
<li><p>%DYNAMIC_METADATA(com.test.my_filter:test_key)% will log: <code class="docutils literal notranslate"><span class="pre">&quot;foo&quot;</span></code></p></li>
<li><p>%DYNAMIC_METADATA(com.test.my_filter:test_object)% will log: <code class="docutils literal notranslate"><span class="pre">{&quot;inner_key&quot;:</span> <span class="pre">&quot;bar&quot;}</span></code></p></li>
<li><p>%DYNAMIC_METADATA(com.test.my_filter:test_object:inner_key)% will log: <code class="docutils literal notranslate"><span class="pre">&quot;bar&quot;</span></code></p></li>
<li><p>%DYNAMIC_METADATA(com.unknown_filter)% will log: <code class="docutils literal notranslate"><span class="pre">-</span></code></p></li>
<li><p>%DYNAMIC_METADATA(com.test.my_filter:unknown_key)% will log: <code class="docutils literal notranslate"><span class="pre">-</span></code></p></li>
<li><p>%DYNAMIC_METADATA(com.test.my_filter):25% will log (truncation at 25 characters): <code class="docutils literal notranslate"><span class="pre">{&quot;test_key&quot;:</span> <span class="pre">&quot;foo&quot;,</span> <span class="pre">&quot;test</span></code></p></li>
</ul>
</dd>
<dt>TCP</dt><dd><p>未实现 (“-“)。</p>
</dd>
</dl>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>对于确定类型的 JSON 日志，当引用的关键字是单值时，这个运算法渲染成字符串、数值或布尔类型的单值。
如果引用的关键字是一个结构或者列表值，会被渲染成 JSON 的结构或者列表。 结构和列表可能是嵌套的，则最大长度的限制会被忽略。</p>
</div>
</dd>
</dl>
<dl id="config-access-log-format-filter-state">
<dt>%FILTER_STATE(KEY:F):Z%</dt><dd><dl class="simple">
<dt>HTTP</dt><dd><p><a class="reference internal" href="../../../intro/arch_overview/advanced/data_sharing_between_filters.html#arch-overview-data-sharing-between-filters"><span class="std std-ref">过滤器状态</span></a> 信息，KEY 是查找过滤器状态对象的必选项。
被序列化的 proto 会尽可能的被记录成 JSON 字符串。
如果对于 Envoy 来说被序列化的 proto 是未知类型，它会被记录成 protobuf 调试字符串。
Z 是一个可选参数，表示字符串截断至 Z 字符长。
F 是一个可选参数，表明采用哪个 FilterState 方法，完成序列化。
如果 ‘PLAIN’ 设置了，过滤器状态对象会被序列化成一个非结构化字符串。
如果 ‘TYPED’ 设置了或者没有提供 F，过滤器状态对象会被序列化成一个 JSON 字符串。</p>
</dd>
<dt>TCP</dt><dd><p>和 HTTP 相同，过滤器状态来自于连接而非一个 L7 层的请求。</p>
</dd>
</dl>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>对于确定类型的 JSON 日志，当引用的关键字是单值时，这个运算法渲染成字符串、数值或布尔类型的单值。
如果引用的关键字是一个结构或者列表值，会被渲染成 JSON 的结构或者列表。 结构和列表可能是嵌套的，则最大长度的限制会被忽略。</p>
</div>
</dd>
<dt>%REQUESTED_SERVER_NAME%</dt><dd><dl class="simple">
<dt>HTTP</dt><dd><p>设置在 ssl 连接套接字上表示服务器名称指示 (SNI) 的字符值</p>
</dd>
<dt>TCP</dt><dd><p>设置在 ssl 连接套接字上表示服务器名称指示 (SNI) 的字符值</p>
</dd>
</dl>
</dd>
<dt>%DOWNSTREAM_LOCAL_URI_SAN%</dt><dd><dl class="simple">
<dt>HTTP</dt><dd><p>用于建立下游 TLS 连接的本地 SAN 证书中的 URI。</p>
</dd>
<dt>TCP</dt><dd><p>用于建立下游 TLS 连接的本地 SAN 证书中的 URI。</p>
</dd>
</dl>
</dd>
<dt>%DOWNSTREAM_PEER_URI_SAN%</dt><dd><dl class="simple">
<dt>HTTP</dt><dd><p>用于建立下游 TLS 连接的对端 SAN 证书中的 URI。</p>
</dd>
<dt>TCP</dt><dd><p>用于建立下游 TLS 连接的对端 SAN 证书中的 URI。</p>
</dd>
</dl>
</dd>
<dt>%DOWNSTREAM_LOCAL_SUBJECT%</dt><dd><dl class="simple">
<dt>HTTP</dt><dd><p>用于建立下游 TLS 连接的本地证书中的主题。</p>
</dd>
<dt>TCP</dt><dd><p>用于建立下游 TLS 连接的本地证书中的主题。</p>
</dd>
</dl>
</dd>
<dt>%DOWNSTREAM_PEER_SUBJECT%</dt><dd><dl class="simple">
<dt>HTTP</dt><dd><p>用于建立下游 TLS 连接的对端证书中的主题。</p>
</dd>
<dt>TCP</dt><dd><p>用于建立下游 TLS 连接的对端证书中的主题。</p>
</dd>
</dl>
</dd>
<dt>%DOWNSTREAM_PEER_ISSUER%</dt><dd><dl class="simple">
<dt>HTTP</dt><dd><p>用于建立下游 TLS 连接的对端证书的颁发者。</p>
</dd>
<dt>TCP</dt><dd><p>用于建立下游 TLS 连接的对端证书的颁发者。</p>
</dd>
</dl>
</dd>
<dt>%DOWNSTREAM_TLS_SESSION_ID%</dt><dd><dl class="simple">
<dt>HTTP</dt><dd><p>已建立的下游 TLS 连接的会话 ID。</p>
</dd>
<dt>TCP</dt><dd><p>已建立的下游 TLS 连接的会话 ID。</p>
</dd>
</dl>
</dd>
<dt>%DOWNSTREAM_TLS_CIPHER%</dt><dd><dl class="simple">
<dt>HTTP</dt><dd><p>用于建立下游 TLS 连接的加密算法集的 OpenSSL 名称。</p>
</dd>
<dt>TCP</dt><dd><p>用于建立下游 TLS 连接的加密算法集的 OpenSSL 名称。</p>
</dd>
</dl>
</dd>
<dt>%DOWNSTREAM_TLS_VERSION%</dt><dd><dl class="simple">
<dt>HTTP</dt><dd><p>用于建立下游 TLS 连接的 TLS 版本（如，<code class="docutils literal notranslate"><span class="pre">TLSv1.2</span></code>，<code class="docutils literal notranslate"><span class="pre">TLSv1.3</span></code>）。</p>
</dd>
<dt>TCP</dt><dd><p>用于建立下游 TLS 连接的 TLS 版本（如，<code class="docutils literal notranslate"><span class="pre">TLSv1.2</span></code>，<code class="docutils literal notranslate"><span class="pre">TLSv1.3</span></code>）。</p>
</dd>
</dl>
</dd>
<dt>%DOWNSTREAM_PEER_FINGERPRINT_256%</dt><dd><dl class="simple">
<dt>HTTP</dt><dd><p>用于建立下游 TLS 连接的客户端证书的十六进制编码 SHA256 指纹。</p>
</dd>
<dt>TCP</dt><dd><p>用于建立下游 TLS 连接的客户端证书的十六进制编码 SHA256 指纹。</p>
</dd>
</dl>
</dd>
<dt>%DOWNSTREAM_PEER_FINGERPRINT_1%</dt><dd><dl class="simple">
<dt>HTTP</dt><dd><p>用于建立下游 TLS 连接的客户端证书的十六进制编码 SHA1 指纹。</p>
</dd>
<dt>TCP</dt><dd><p>用于建立下游 TLS 连接的客户端证书的十六进制编码 SHA1 指纹。</p>
</dd>
</dl>
</dd>
<dt>%DOWNSTREAM_PEER_SERIAL%</dt><dd><dl class="simple">
<dt>HTTP</dt><dd><p>用于建立下游 TLS 连接的客户端证书的序列号。</p>
</dd>
<dt>TCP</dt><dd><p>用于建立下游 TLS 连接的客户端证书的序列号。</p>
</dd>
</dl>
</dd>
<dt>%DOWNSTREAM_PEER_CERT%</dt><dd><dl class="simple">
<dt>HTTP</dt><dd><p>基于URL-encoded PEM 格式的客户端证书，该证书用于建立下游 TLS 连接的。</p>
</dd>
<dt>TCP</dt><dd><p>基于URL-encoded PEM 格式的客户端证书，该证书用于建立下游 TLS 连接的。</p>
</dd>
</dl>
</dd>
<dt>%DOWNSTREAM_PEER_CERT_V_START%</dt><dd><dl class="simple">
<dt>HTTP</dt><dd><p>客户端证书的有效起始日期，该证书用于建立下游 TLS 连接。</p>
</dd>
<dt>TCP</dt><dd><p>客户端证书的有效起始日期，该证书用于建立下游 TLS 连接。</p>
</dd>
</dl>
</dd>
<dt>%DOWNSTREAM_PEER_CERT_V_END%</dt><dd><dl class="simple">
<dt>HTTP</dt><dd><p>客户端证书的有效结束日期，该证书用于建立下游 TLS 连接。</p>
</dd>
<dt>TCP</dt><dd><p>客户端证书的有效结束日期，该证书用于建立下游 TLS 连接。</p>
</dd>
</dl>
</dd>
<dt>%HOSTNAME%</dt><dd><p>系统主机名。</p>
</dd>
<dt>%LOCAL_REPLY_BODY%</dt><dd><p>被 Envoy 拒绝的请求体文本。</p>
</dd>
</dl>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../../security/security.html" class="btn btn-neutral float-right" title="安全" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="stats.html" class="btn btn-neutral float-left" title="统计" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2016-2020, Envoy Project Authors

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>