

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>运行时 &mdash; envoy 1.16.0-e77e0f documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/envoy.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/sphinx_tabs/semantic-ui-2.4.1/segment.min.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/sphinx_tabs/semantic-ui-2.4.1/menu.min.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/sphinx_tabs/semantic-ui-2.4.1/tab.min.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/sphinx_tabs/tabs.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/copybutton.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
        <script src="../../_static/clipboard.min.js"></script>
        <script src="../../_static/copybutton.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="过载管理器" href="overload_manager/overload_manager.html" />
    <link rel="prev" title="操作" href="operations.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html">
          

          
            
            <img src="../../_static/envoy-logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                1.16.0-e77e0f
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../about_docs.html">关于文档</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../intro/intro.html">介绍</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../start/start.html">开始</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install/install.html">构建和安装</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../version_history/version_history.html">Version history</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../configuration.html">配置参考</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../overview/overview.html">概览</a></li>
<li class="toctree-l2"><a class="reference internal" href="../listeners/listeners.html">监听器</a></li>
<li class="toctree-l2"><a class="reference internal" href="../http/http.html">HTTP</a></li>
<li class="toctree-l2"><a class="reference internal" href="../upstream/upstream.html">上游集群</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observability/observability.html">可观测性</a></li>
<li class="toctree-l2"><a class="reference internal" href="../security/security.html">安全</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="operations.html">操作</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">运行时</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#config-virtual-filesystem">虚拟文件系统</a></li>
<li class="toctree-l4"><a class="reference internal" href="#config-runtime-atomicity">原子性</a></li>
<li class="toctree-l4"><a class="reference internal" href="#protobuf-json">Protobuf 和 JSON 描述</a></li>
<li class="toctree-l4"><a class="reference internal" href="#config-runtime-comments">注释</a></li>
<li class="toctree-l4"><a class="reference internal" href="#config-runtime-deprecation">使用运行时复写处理弃用特性</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id13">统计</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="overload_manager/overload_manager.html">过载管理器</a></li>
<li class="toctree-l3"><a class="reference internal" href="tools/router_check.html">Route table check tool</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../other_features/other_features.html">其他特性</a></li>
<li class="toctree-l2"><a class="reference internal" href="../other_protocols/other_protocols.html">其他协议</a></li>
<li class="toctree-l2"><a class="reference internal" href="../advanced/advanced.html">高级配置</a></li>
<li class="toctree-l2"><a class="reference internal" href="../best_practices/best_practices.html">配置最佳实践</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../operations/operations.html">操作和管理</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../extending/extending.html">Extending Envoy for custom use cases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/api.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../faq/overview.html">FAQ</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">envoy</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../configuration.html">配置参考</a> &raquo;</li>
        
          <li><a href="operations.html">操作</a> &raquo;</li>
        
      <li>运行时</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/configuration/operations/runtime.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="config-runtime">
<span id="id1"></span><h1>运行时<a class="headerlink" href="#config-runtime" title="Permalink to this headline">¶</a></h1>
<p><a class="reference internal" href="../../intro/arch_overview/operations/runtime.html#arch-overview-runtime"><span class="std std-ref">运行时配置</span></a> 详述了一个包含有可重复加载配置元素的虚拟文件系统。可以通过
一系列本地文件系统、静态 bootstrap 配置、RTDS 和管理控制台衍生的 overlays 来实现虚拟文件系统。</p>
<ul class="simple">
<li><p><a class="reference internal" href="../../api-v3/config/bootstrap/v3/bootstrap.proto.html#envoy-v3-api-msg-config-bootstrap-v3-runtime"><span class="std std-ref">v3 API 参考</span></a></p></li>
</ul>
<div class="section" id="config-virtual-filesystem">
<span id="id2"></span><h2>虚拟文件系统<a class="headerlink" href="#config-virtual-filesystem" title="Permalink to this headline">¶</a></h2>
<div class="section" id="config-runtime-layering">
<span id="id3"></span><h3>分层<a class="headerlink" href="#config-runtime-layering" title="Permalink to this headline">¶</a></h3>
<p>运行时可被视为是一个包含多层的虚拟文件系统。<a class="reference internal" href="../../api-v3/config/bootstrap/v3/bootstrap.proto.html#envoy-v3-api-msg-config-bootstrap-v3-layeredruntime"><span class="std std-ref">层级运行时</span></a>
bootstrap 配置详述了这个分层。后一层中的运行时设置会覆盖前一层。一种典型的配置会是：</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">layers</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">static_layer_0</span>
  <span class="nt">static_layer</span><span class="p">:</span>
    <span class="nt">health_check</span><span class="p">:</span>
      <span class="nt">min_interval</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">5</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">disk_layer_0</span>
  <span class="nt">disk_layer</span><span class="p">:</span> <span class="p p-Indicator">{</span><span class="nt"> symlink_root</span><span class="p">:</span> <span class="nv">/srv/runtime/current</span><span class="p p-Indicator">,</span><span class="nt"> subdirectory</span><span class="p">:</span> <span class="nv">envoy</span> <span class="p p-Indicator">}</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">disk_layer_1</span>
  <span class="nt">disk_layer</span><span class="p">:</span> <span class="p p-Indicator">{</span><span class="nt"> symlink_root</span><span class="p">:</span> <span class="nv">/srv/runtime/current</span><span class="p p-Indicator">,</span><span class="nt"> subdirectory</span><span class="p">:</span> <span class="nv">envoy_override</span><span class="p p-Indicator">,</span><span class="nt"> append_service_cluster</span><span class="p">:</span> <span class="nv">true</span> <span class="p p-Indicator">}</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">admin_layer_0</span>
  <span class="nt">admin_layer</span><span class="p">:</span> <span class="p p-Indicator">{}</span>
</pre></div>
</div>
<p>在弃用的 <a class="reference internal" href="../../api-v3/config/bootstrap/v3/bootstrap.proto.html#envoy-v3-api-msg-config-bootstrap-v3-runtime"><span class="std std-ref">运行时</span></a> bootstrap 配置中，分层是隐式且固定的：</p>
<ol class="arabic simple">
<li><p><a class="reference internal" href="#config-runtime-bootstrap"><span class="std std-ref">静态 bootstrap 配置</span></a></p></li>
<li><p><a class="reference internal" href="#config-runtime-local-disk"><span class="std std-ref">本地磁盘文件系统</span></a></p></li>
<li><p><a class="reference internal" href="#config-runtime-local-disk"><span class="std std-ref">本地磁盘文件系统  *override_subdirectory*</span></a></p></li>
<li><p><a class="reference internal" href="#config-runtime-admin"><span class="std std-ref">管理控制台覆盖</span></a></p></li>
</ol>
<p>高层中的值会覆盖低层中相应的值。</p>
</div>
<div class="section" id="config-runtime-file-system">
<span id="id4"></span><h3>文件系统布局<a class="headerlink" href="#config-runtime-file-system" title="Permalink to this headline">¶</a></h3>
<p>配置指南中的不同部分描述了可用的运行时配置。例如，<a class="reference internal" href="../upstream/cluster_manager/cluster_runtime.html#config-cluster-manager-cluster-runtime"><span class="std std-ref">这儿</span></a> 是针对上游集群的运行时设置。</p>
<p>在运行时中的每个‘.’指示了层次结构中的新目录，路径的末端部分是文件。文件的内容构成了运行时的值。当从一个文件读取数值时，空格和新行将会被忽略。</p>
<p><em>numerator</em> 或 <em>denominator</em> 是预留的关键字，不能出现在任何目录中。</p>
</div>
<div class="section" id="bootstrap">
<span id="config-runtime-bootstrap"></span><h3>静态 bootstrap<a class="headerlink" href="#bootstrap" title="Permalink to this headline">¶</a></h3>
<p>一个静态的基础运行时可以在 <a class="reference internal" href="../../api-v3/config/bootstrap/v3/bootstrap.proto.html#envoy-v3-api-field-config-bootstrap-v3-runtime-base"><span class="std std-ref">bootstrap 配置</span></a> 中通过一个:ref:<cite>protobuf JSON 描述 &lt;config_runtime_proto_json&gt;</cite> 来指定。</p>
</div>
<div class="section" id="config-runtime-local-disk">
<span id="id5"></span><h3>本地磁盘文件系统<a class="headerlink" href="#config-runtime-local-disk" title="Permalink to this headline">¶</a></h3>
<p>当在本地磁盘上实现了 <a class="reference internal" href="#config-runtime-file-system"><span class="std std-ref">运行时虚拟文件系统</span></a> 时，它的根在 <em>symlink_root</em> + <em>subdirectory</em>。例如，<em>health_check.min_interval</em> 键将有用如下的全文件系统路径（使用符号链接）：</p>
<p><code class="docutils literal notranslate"><span class="pre">/srv/runtime/current/envoy/health_check/min_interval</span></code></p>
<div class="section" id="config-runtime-local-disk-overrides">
<span id="id6"></span><h4>覆盖<a class="headerlink" href="#config-runtime-local-disk-overrides" title="Permalink to this headline">¶</a></h4>
<p>任意数量的磁盘文件系统层可以在 <a class="reference internal" href="../../api-v3/config/bootstrap/v3/bootstrap.proto.html#envoy-v3-api-msg-config-bootstrap-v3-layeredruntime"><span class="std std-ref">层级运行时</span></a> bootstrap 配置中进行覆盖。</p>
<p>在弃用的 <a class="reference internal" href="../../api-v3/config/bootstrap/v3/bootstrap.proto.html#envoy-v3-api-msg-config-bootstrap-v3-runtime"><span class="std std-ref">运行时</span></a> bootstrap 配置中，有一个可分辨的文件系统覆盖。假定文件夹  <code class="docutils literal notranslate"><span class="pre">/srv/runtime/v1</span></code> 指向存储在全局运行时配置中的实际文件系统路径。下面将会是一个针对运行时设置的典型配置：</p>
<ul class="simple">
<li><p><em>symlink_root</em>: <code class="docutils literal notranslate"><span class="pre">/srv/runtime/current</span></code></p></li>
<li><p><em>subdirectory</em>: <code class="docutils literal notranslate"><span class="pre">envoy</span></code></p></li>
<li><p><em>override_subdirectory</em>: <code class="docutils literal notranslate"><span class="pre">envoy_override</span></code></p></li>
</ul>
<p>其中 <code class="docutils literal notranslate"><span class="pre">/srv/runtime/current</span></code> 是一个链接至 <code class="docutils literal notranslate"><span class="pre">/srv/runtime/v1</span></code> 的符号链接。</p>
</div>
<div class="section" id="config-runtime-local-disk-service-cluster-subdirs">
<span id="id7"></span><h4>特定于集群的子目录<a class="headerlink" href="#config-runtime-local-disk-service-cluster-subdirs" title="Permalink to this headline">¶</a></h4>
<p>在弃用的 <a class="reference internal" href="../../api-v3/config/bootstrap/v3/bootstrap.proto.html#envoy-v3-api-msg-config-bootstrap-v3-runtime"><span class="std std-ref">运行时</span></a> bootstrap 配置中， <em>override_subdirectory</em> 和命令行选项中的 <a class="reference internal" href="../../operations/cli.html#cmdoption-service-cluster"><code class="xref std std-option docutils literal notranslate"><span class="pre">--service-cluster</span></code></a> 一起使用。假定 <a class="reference internal" href="../../operations/cli.html#cmdoption-service-cluster"><code class="xref std std-option docutils literal notranslate"><span class="pre">--service-cluster</span></code></a> 选项被设置为 <code class="docutils literal notranslate"><span class="pre">my-cluster</span></code> 。Envoy 会首先在下面的全文件系统路径中查找 <em>health_check.min_interval</em> 键：</p>
<p><code class="docutils literal notranslate"><span class="pre">/srv/runtime/current/envoy_override/my-cluster/health_check/min_interval</span></code></p>
<p>如果找到，则找到的的值值会对主查找路径中找到的任意值进行覆盖。这允许用户在全局默认值之上自定义单个集群的运行时值。</p>
<p>使用 <a class="reference internal" href="../../api-v3/config/bootstrap/v3/bootstrap.proto.html#envoy-v3-api-msg-config-bootstrap-v3-layeredruntime"><span class="std std-ref">层级运行时</span></a> bootstrap 配置，在任意磁盘层上通过 <a class="reference internal" href="../../api-v3/config/bootstrap/v3/bootstrap.proto.html#envoy-v3-api-field-config-bootstrap-v3-runtimelayer-disklayer-append-service-cluster"><span class="std std-ref">append_service_cluster</span></a> 选项来在服务集群上进行定制化是可能的。</p>
</div>
<div class="section" id="config-runtime-symbolic-link-swap">
<span id="id8"></span><h4>通过符号链接交换来更新运行时<a class="headerlink" href="#config-runtime-symbolic-link-swap" title="Permalink to this headline">¶</a></h4>
<p>更新任意运行时的值，需要分两步走。第一步，创建一个完整运行时树的硬拷贝，然后更新期望的运行时值。第二步，使用等同于如下的命令来实现符号链接根从旧运行时树到新运行时树的自动交换：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">/srv/runtime:~$ ln -s /srv/runtime/v2 new &amp;&amp; mv -Tf new current</span>
</pre></div>
</div>
<p>文件系统数据的部署、垃圾回收等不在此文档的讨论范畴内。</p>
</div>
</div>
<div class="section" id="rtds">
<span id="config-runtime-rtds"></span><h3>运行时发现服务（RTDS）<a class="headerlink" href="#rtds" title="Permalink to this headline">¶</a></h3>
<p>通过设定 <a class="reference internal" href="../../api-v3/config/bootstrap/v3/bootstrap.proto.html#envoy-v3-api-field-config-bootstrap-v3-runtimelayer-rtds-layer"><span class="std std-ref">rtds_layer</span></a> 来指定和传送一个或多个运行时层。这将运行时层指向常规的 <a class="reference internal" href="../../api-docs/xds_protocol.html#xds-protocol"><span class="std std-ref">xDS</span></a> 端点，能为给定的层订阅单个的 xDS 资源。那些层的资源类型是一种 <a class="reference internal" href="../../api-v3/service/runtime/v3/rtds.proto.html#envoy-v3-api-msg-service-runtime-v3-runtime"><span class="std std-ref">运行时消息</span></a>。</p>
</div>
<div class="section" id="config-runtime-admin">
<span id="id9"></span><h3>管理控制台<a class="headerlink" href="#config-runtime-admin" title="Permalink to this headline">¶</a></h3>
<p>可以在 <a class="reference internal" href="../../operations/admin.html#operations-admin-interface-runtime"><span class="std std-ref">/runtime admin endpoint</span></a> 中查看值。可以在  <a class="reference internal" href="../../operations/admin.html#operations-admin-interface-runtime-modify"><span class="std std-ref">/runtime_modify admin endpoint</span></a> 中对值进行修改和添加。如果没有配置运行时，就会使用空的 provider，这和使用内置于代码中的所有默认值是一样的，除了那些通过 <cite>/runtime_modify</cite> 来添加的值。</p>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>使用 <a class="reference internal" href="../../operations/admin.html#operations-admin-interface-runtime-modify"><span class="std std-ref">/runtime_modify</span></a> 端点的时候要小心。变化会立即生效。
管理接口 <a class="reference internal" href="../../operations/admin.html#operations-admin-interface-security"><span class="std std-ref">正确的配置安全</span></a> 是非常重要的。</p>
</div>
<p>最多可指定一个管理层。如果指定了一个管理层缺失的非空 <a class="reference internal" href="../../api-v3/config/bootstrap/v3/bootstrap.proto.html#envoy-v3-api-msg-config-bootstrap-v3-layeredruntime"><span class="std std-ref">层级运行时</span></a> bootstrap 配置，任何改变管理控制台的操作将会引发 503 响应。</p>
</div>
</div>
<div class="section" id="config-runtime-atomicity">
<span id="id10"></span><h2>原子性<a class="headerlink" href="#config-runtime-atomicity" title="Permalink to this headline">¶</a></h2>
<p>在下列情形中，运行时将重新加载并生成一个新的快照：</p>
<ul class="simple">
<li><p>当在符号链接根（symlink root）下检测到有文件移动操作发生或符号链接根发生变化时。</p></li>
<li><p>当添加或修改管理控制台覆盖时。</p></li>
</ul>
<p>所有的运行时层在快照期间都会被评估。错误层会被忽略并从有效层里面剔除，可查看 <a class="reference internal" href="#runtime-stats"><span class="std std-ref">num_layers</span></a>。遍历符号链接根将花费一些很少的时间，因此如果期望真正的原子性，则运行时目录应该是不可变的且符号链接变化应该被用来对更新进行编排。</p>
<p>当检测到文件移动时，相同符号链接根的磁盘层将仅仅触发一次刷新。不完全相同的重叠符号链接根路径的磁盘层，在检测到文件移动时，可能会触发多次重新加载。</p>
</div>
<div class="section" id="protobuf-json">
<span id="config-runtime-proto-json"></span><h2>Protobuf 和 JSON 描述<a class="headerlink" href="#protobuf-json" title="Permalink to this headline">¶</a></h2>
<p>运行时 <a class="reference internal" href="#config-runtime-file-system"><span class="std std-ref">文件系统</span></a> 可以在一个 proto3 消息中表示为  <a class="reference external" href="https://developers.google.com/protocol-buffers/docs/reference/google.protobuf#google.protobuf.Struct">google.protobuf.Struct</a> ，且以如下规则为 JSON 对象建模：</p>
<ul class="simple">
<li><p>点分隔符映射至树边缘。</p></li>
<li><p>变量叶子（整数、字符、布尔、双精度）均以他们自身的 JSON 类型来表示。 (integer, strings, booleans, doubles) are represented with their respective JSON type.</p></li>
<li><p><a class="reference internal" href="../../api-v3/type/v3/percent.proto.html#envoy-v3-api-msg-type-v3-fractionalpercent"><span class="std std-ref">FractionalPercent</span></a> is represented with via its
<a class="reference external" href="https://developers.google.com/protocol-buffers/docs/proto3#json">canonical JSON encoding</a>.</p></li>
</ul>
<p>关于 <em>health_check.min_interval</em> 键值在 YAML 文件中的示例如下：</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">health_check</span><span class="p">:</span>
  <span class="nt">min_interval</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">5</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>从双精度解析而来的整数会向下取舍为最接近的整数。</p>
</div>
</div>
<div class="section" id="config-runtime-comments">
<span id="id11"></span><h2>注释<a class="headerlink" href="#config-runtime-comments" title="Permalink to this headline">¶</a></h2>
<p>第一个字母以 <code class="docutils literal notranslate"><span class="pre">#</span></code> 开头的行被视为注释。</p>
<p>注释可被用来在对现有值提供上下文。注释在其他空文件中也很有用，以便在需要时保留占位符以便部署。</p>
</div>
<div class="section" id="config-runtime-deprecation">
<span id="id12"></span><h2>使用运行时复写处理弃用特性<a class="headerlink" href="#config-runtime-deprecation" title="Permalink to this headline">¶</a></h2>
<p>Envoy 运行时也是 Envoy 功能弃用流程的一部分。</p>
<p>如在 Envoy <a class="reference external" href="https://github.com/envoyproxy/envoy/blob/e77e0f6007485aaa30d9d40429a4e211f6ddfe52/CONTRIBUTING.md#breaking-change-policy">重大变更策略</a> 中所描述，Envoy 中的功能弃用分三个阶段：warn-by-default、fail-by-default 和 代码移除（code removal）。</p>
<p>在第一阶段，Envoy 在告警日志中会打印告警，表明功能要被弃用且会增加 <a class="reference internal" href="#runtime-stats"><span class="std std-ref">deprecated_feature_use</span></a> 运行时统计。鼓励用户去 <a class="reference internal" href="../../version_history/version_history.html#deprecated"><span class="std std-ref">弃用</span></a> 中查看如何迁移到新的代码路径，确保这能够适用于他们的用例。</p>
<p>在第二阶段，字段将被标记为 disallowed_by_default，默认情况下，使用此字段进行配置将会导致配置被拒绝。这种禁止模式可在运行时配置中通过将 envoy.deprecated_features:full_fieldname 或 envoy.deprecated_features:full_enum_value 设置为 true 来进行覆盖。例如，对于一个弃用字段 <code class="docutils literal notranslate"><span class="pre">Foo.Bar.Eep</span></code> ，将 <code class="docutils literal notranslate"><span class="pre">envoy.deprecated_features:Foo.bar.Eep</span></code> 设置为 <code class="docutils literal notranslate"><span class="pre">true</span></code> 。这有一个生产例子，使用静态运行时来允许 fail-by-default 字段，可查看这儿 <a class="reference external" href="https://github.com/envoyproxy/envoy/blob/e77e0f6007485aaa30d9d40429a4e211f6ddfe52/configs/using_deprecated_config.v2.yaml">configs/using_deprecated_config.v2.yaml</a> 。<strong>极其不鼓励</strong> 去使用这些覆盖，所以使用时请注意，应尽早切换至新字段。Fatal-by-default 配置预示了旧代码路径的移除是迫在眉睫了。如果新代码路径中的任何缺陷或者功能问题能够提前被清除，而不是在代码移除之后，这对于Envoy 用户和 Envoy 贡献者来说都是非常好的！</p>
<div class="admonition attention" id="runtime-stats">
<p class="admonition-title">Attention</p>
<p>版本高于 1.14.1 的 Envoy，不能够将整数值解析为运行时布尔值，这需要显示的设定为“true”或者“false”。如果错误的让诸如“0”这样的整数值代表“false”的话，会导致直接使用默认值。这一点对于 <a class="reference internal" href="../../version_history/version_history.html#deprecated"><span class="std std-ref">弃用功能</span></a> 的运行时覆盖尤为重要，因为这将会导致非预期的 Envoy 行为。</p>
</div>
</div>
<div class="section" id="id13">
<h2>统计<a class="headerlink" href="#id13" title="Permalink to this headline">¶</a></h2>
<p>文件系统运行时提供者会在 <em>runtime.</em> 命名空间下发出一些统计。</p>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>名称</p></th>
<th class="head"><p>类型</p></th>
<th class="head"><p>描述</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>admin_overrides_active</p></td>
<td><p>Gauge</p></td>
<td><p>如有任何管理覆盖处于激活状态则为 1 ，否则为 0。</p></td>
</tr>
<tr class="row-odd"><td><p>deprecated_feature_use</p></td>
<td><p>Counter</p></td>
<td><p>使用弃用功能的次数。使用功能的详细信息将会以“从文件 Y 使用弃用选项‘X’”的格式被记录在告警日志中。</p></td>
</tr>
<tr class="row-even"><td><p>deprecated_feature_seen_since_process_start</p></td>
<td><p>Gauge</p></td>
<td><p>使用弃用功能的次数。这在热重启期间不会计入统计。</p></td>
</tr>
<tr class="row-odd"><td><p>load_error</p></td>
<td><p>Counter</p></td>
<td><p>在任何层中导致错误的加载尝试总数</p></td>
</tr>
<tr class="row-even"><td><p>load_success</p></td>
<td><p>Counter</p></td>
<td><p>在所有层中加载尝试成功的总数</p></td>
</tr>
<tr class="row-odd"><td><p>num_keys</p></td>
<td><p>Gauge</p></td>
<td><p>当前加载的键（key）数</p></td>
</tr>
<tr class="row-even"><td><p>num_layers</p></td>
<td><p>Gauge</p></td>
<td><p>当前活跃的层数（没有加载错误）</p></td>
</tr>
<tr class="row-odd"><td><p>override_dir_exists</p></td>
<td><p>Counter</p></td>
<td><p>使用覆盖目录的负载总数</p></td>
</tr>
<tr class="row-even"><td><p>override_dir_not_exists</p></td>
<td><p>Counter</p></td>
<td><p>不使用覆盖目录的负载总数</p></td>
</tr>
</tbody>
</table>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="overload_manager/overload_manager.html" class="btn btn-neutral float-right" title="过载管理器" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="operations.html" class="btn btn-neutral float-left" title="操作" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2016-2021, Envoy Project Authors

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>