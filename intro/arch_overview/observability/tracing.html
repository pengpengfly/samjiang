

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>追踪 &mdash; envoy 1.16.0-666f25 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/envoy.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/sphinx_tabs/semantic-ui-2.4.1/segment.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/sphinx_tabs/semantic-ui-2.4.1/menu.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/sphinx_tabs/semantic-ui-2.4.1/tab.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/sphinx_tabs/tabs.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/copybutton.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
        <script src="../../../_static/clipboard.min.js"></script>
        <script src="../../../_static/copybutton.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="安全" href="../security/security.html" />
    <link rel="prev" title="访问日志" href="access_logging.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html">
          

          
            
            <img src="../../../_static/envoy-logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                1.16.0-666f25
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../about_docs.html">关于文档</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../intro.html">介绍</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../what_is_envoy.html">Envoy 是什么？</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../arch_overview.html">架构概览</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../intro/intro.html">介绍</a></li>
<li class="toctree-l3"><a class="reference internal" href="../listeners/listeners_toc.html">监听器</a></li>
<li class="toctree-l3"><a class="reference internal" href="../http/http.html">HTTP</a></li>
<li class="toctree-l3"><a class="reference internal" href="../upstream/upstream.html">上游集群</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="observability.html">可观察性</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="statistics.html">统计</a></li>
<li class="toctree-l4"><a class="reference internal" href="access_logging.html">访问日志</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">追踪</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../security/security.html">安全</a></li>
<li class="toctree-l3"><a class="reference internal" href="../operations/operations.html">操作与配置</a></li>
<li class="toctree-l3"><a class="reference internal" href="../other_features/other_features.html">其他特性</a></li>
<li class="toctree-l3"><a class="reference internal" href="../other_protocols/other_protocols.html">其他协议</a></li>
<li class="toctree-l3"><a class="reference internal" href="../advanced/advanced.html">高级的</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../life_of_a_request.html">请求的生命周期</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../deployment_types/deployment_types.html">部署类型</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../getting_help.html">获取帮助</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../start/start.html">开始</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../install/install.html">构建和安装</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../version_history/version_history.html">Version history</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../configuration/configuration.html">配置参考</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../operations/operations.html">Operations and administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../extending/extending.html">Extending Envoy for custom use cases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/api.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/overview.html">FAQ</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">envoy</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../intro.html">介绍</a> &raquo;</li>
        
          <li><a href="../arch_overview.html">架构概览</a> &raquo;</li>
        
          <li><a href="observability.html">可观察性</a> &raquo;</li>
        
      <li>追踪</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../_sources/intro/arch_overview/observability/tracing.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="arch-overview-tracing">
<span id="id1"></span><h1>追踪<a class="headerlink" href="#arch-overview-tracing" title="Permalink to this headline">¶</a></h1>
<div class="section" id="id2">
<h2>概览<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p>在大规模的面向服务的架构中，分布式追踪能让开发者得到调用流程的可视化展示。在了解序列化、并行情况和延迟来源的时候，
可视化就显得格外重要。Envoy 支持三个系统范围内追踪的特性：</p>
<ul class="simple">
<li><dl class="simple">
<dt><strong>生成 Request ID</strong>: Envoy 会在需要的时候生成 UUIDs，并且填充名为 <a class="reference internal" href="../../../configuration/http/http_conn_man/headers.html#config-http-conn-man-headers-x-request-id"><span class="std std-ref">x-request-id</span></a> 的 HTTP header。</dt><dd><p>应用可以转发这个 x-request-id Header 来做到统一的记录和跟踪。这个行为可以通过用一个 extension 在每个基于 <a class="reference internal" href="../../../api-v3/extensions/filters/network/http_connection_manager/v3/http_connection_manager.proto.html#envoy-v3-api-field-extensions-filters-network-http-connection-manager-v3-httpconnectionmanager-request-id-extension"><span class="std std-ref">HTTP connection manager</span></a> 上配置。</p>
</dd>
</dl>
</li>
<li><p><strong>客户端跟踪 ID 连接</strong>: <a class="reference internal" href="../../../configuration/http/http_conn_man/headers.html#config-http-conn-man-headers-x-client-trace-id"><span class="std std-ref">x-client-trace-id</span></a> header 能够把不信任的请求 ID 连接到受信任的内部 <a class="reference internal" href="../../../configuration/http/http_conn_man/headers.html#config-http-conn-man-headers-x-request-id"><span class="std std-ref">x-request-id</span></a> header 上。</p></li>
<li><p><strong>集成外部跟踪服务</strong>: Envoy 支持插件式的外部可视化跟踪提供者，有两种不同的类型：</p>
<ul>
<li><p>基于代码级别的外部跟踪服务，像 <a class="reference external" href="https://lightstep.com/">LightStep</a>, <a class="reference external" href="https://zipkin.io/">Zipkin</a> 或者 任何兼容 Zipkin 的后端服务（例如：<a class="reference external" href="https://github.com/jaegertracing/">Jaeger</a>），
还有 <a class="reference external" href="https://datadoghq.com">Datadog</a>。</p></li>
<li><p>External tracers which are part of the Envoy code base, like <a class="reference external" href="https://lightstep.com/">LightStep</a>,
<a class="reference external" href="https://zipkin.io/">Zipkin</a>  or any Zipkin compatible backends (e.g. <a class="reference external" href="https://github.com/jaegertracing/">Jaeger</a>), and
<a class="reference external" href="https://datadoghq.com">Datadog</a>.</p></li>
<li><p>外部追踪服务作为第三方库的插件，像 <a class="reference external" href="https://www.instana.com/blog/monitoring-envoy-proxy-microservices/">Instana</a>。</p></li>
</ul>
</li>
</ul>
<p>支持添加其它各种类型的的追踪服务也不是什么难事！</p>
</div>
<div class="section" id="id7">
<h2>如何初始化一个跟踪<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h2>
<p>处理请求的 HTTP 管理器必须设置 <a class="reference internal" href="../../../api-v3/extensions/filters/network/http_connection_manager/v3/http_connection_manager.proto.html#envoy-v3-api-msg-extensions-filters-network-http-connection-manager-v3-httpconnectionmanager-tracing"><span class="std std-ref">tracing</span></a> 对象。有多种不同的方式可以初始化跟踪：</p>
<ul class="simple">
<li><p>外部客户端，使用 <a class="reference internal" href="../../../configuration/http/http_conn_man/headers.html#config-http-conn-man-headers-x-client-trace-id"><span class="std std-ref">x-client-trace-id</span></a> header。</p></li>
<li><p>内部服务，使用 <a class="reference internal" href="../../../configuration/http/http_conn_man/headers.html#config-http-conn-man-headers-x-envoy-force-trace"><span class="std std-ref">x-envoy-force-trace</span></a> header。</p></li>
<li><p>通过 <a class="reference internal" href="../../../configuration/http/http_conn_man/runtime.html#config-http-conn-man-runtime-random-sampling"><span class="std std-ref">random_sampling</span></a> 运行时设置来进行随机采样。</p></li>
</ul>
<p>路由过滤器可以使用 <a class="reference internal" href="../../../api-v3/extensions/filters/http/router/v3/router.proto.html#envoy-v3-api-field-extensions-filters-http-router-v3-router-start-child-span"><span class="std std-ref">start_child_span</span></a> 来为 egress 调用创建下级 span。</p>
</div>
<div class="section" id="id8">
<h2>跟踪上下文的传递<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h2>
<p>Envoy 提供了报告网格内服务间通信跟踪信息的能力。然而一个调用流中，会有多个代理服务器生成的跟踪信息碎片，
跟踪服务必须在出入站的请求中传播上下文信息，才能拼出完整的跟踪信息。</p>
<p>不管使用哪种跟踪方式，服务都应该传递 <a class="reference internal" href="../../../configuration/http/http_conn_man/headers.html#config-http-conn-man-headers-x-request-id"><span class="std std-ref">x-request-id</span></a> 来开启调用服务的相关性记录。</p>
<p>为了理解 Span（逻辑工作单元）之间的父子关系，跟踪服务自身也需要更多的上下文信息。这种需要可以
通过在跟踪服务自身中直接使用 LightStep（OpenTracing API）或者 Zipkin 跟踪器来完成，从而
在入站请求中提取跟踪上下文，然后把上下文信息注入到后续的出站请求中。这种方法还可以让服务能够
创建附加的 Span，用来描述服务内部完成的工作。这对端到端跟踪的检查是很有帮助的。</p>
<p>另外，跟踪上下文也可以由服务来完成手动传播：</p>
<ul class="simple">
<li><p>如果使用了 LightStep 跟踪器，在发送 HTTP 请求到其他服务时，Envoy 依赖这个服务来传播 <a class="reference internal" href="../../../configuration/http/http_conn_man/headers.html#config-http-conn-man-headers-x-ot-span-context"><span class="std std-ref">x-ot-span-context</span></a> Header。</p></li>
<li><p>如果使用的是 Zipkin，Envoy 依赖这个服务传播
B3 HTTP headers (
<a class="reference internal" href="../../../configuration/http/http_conn_man/headers.html#config-http-conn-man-headers-x-b3-traceid"><span class="std std-ref">x-b3-traceid</span></a>,
<a class="reference internal" href="../../../configuration/http/http_conn_man/headers.html#config-http-conn-man-headers-x-b3-spanid"><span class="std std-ref">x-b3-spanid</span></a>,
<a class="reference internal" href="../../../configuration/http/http_conn_man/headers.html#config-http-conn-man-headers-x-b3-parentspanid"><span class="std std-ref">x-b3-parentspanid</span></a>,
<a class="reference internal" href="../../../configuration/http/http_conn_man/headers.html#config-http-conn-man-headers-x-b3-sampled"><span class="std std-ref">x-b3-sampled</span></a>, and
<a class="reference internal" href="../../../configuration/http/http_conn_man/headers.html#config-http-conn-man-headers-x-b3-flags"><span class="std std-ref">x-b3-flags</span></a>)。 <a class="reference internal" href="../../../configuration/http/http_conn_man/headers.html#config-http-conn-man-headers-x-b3-sampled"><span class="std std-ref">x-b3-sampled</span></a>
header 也可以由外部客户端在一个特定的请求中打开或者关闭追踪。另外，单个 <a class="reference internal" href="../../../configuration/http/http_conn_man/headers.html#config-http-conn-man-headers-b3"><span class="std std-ref">b3</span></a> header
传递格式是被支持的，这个格式是更加紧凑的格式。</p></li>
<li><p>如果使用的是 Datadog 追踪器, Envoy 依赖这个服务传递特定的 Datadog
HTTP headers (
<a class="reference internal" href="../../../configuration/http/http_conn_man/headers.html#config-http-conn-man-headers-x-datadog-trace-id"><span class="std std-ref">x-datadog-trace-id</span></a>,
<a class="reference internal" href="../../../configuration/http/http_conn_man/headers.html#config-http-conn-man-headers-x-datadog-parent-id"><span class="std std-ref">x-datadog-parent-id</span></a>,
<a class="reference internal" href="../../../configuration/http/http_conn_man/headers.html#config-http-conn-man-headers-x-datadog-sampling-priority"><span class="std std-ref">x-datadog-sampling-priority</span></a>).</p></li>
</ul>
</div>
<div class="section" id="id9">
<h2>每条追踪中包含哪些数据<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h2>
<p>一条端到端的跟踪会包含一个或者多个 Span。一个 Span 就是一个逻辑上的工作单元，具有一个启动时间和时长，
其中还会包含特定的 Metadata，每个 Envoy 生成的 Span 包含如下信息：</p>
<ul class="simple">
<li><p>通过 <a class="reference internal" href="../../../operations/cli.html#cmdoption-service-cluster"><code class="xref std std-option docutils literal notranslate"><span class="pre">--service-cluster</span></code></a> 设置的始发服务集群</p></li>
<li><p>请求的启动时间和持续时间。</p></li>
<li><p>使用 <a class="reference internal" href="../../../operations/cli.html#cmdoption-service-node"><code class="xref std std-option docutils literal notranslate"><span class="pre">--service-node</span></code></a> 设置的始发服务主机。</p></li>
<li><p><a class="reference internal" href="../../../configuration/http/http_conn_man/headers.html#config-http-conn-man-headers-downstream-service-cluster"><span class="std std-ref">x-envoy-downstream-service-cluster</span></a> header 设置的下游集群。</p></li>
<li><p>HTTP 请求 URL, method, protocol 和 user-agent。</p></li>
<li><p>通过 <a class="reference internal" href="../../../api-v3/extensions/filters/network/http_connection_manager/v3/http_connection_manager.proto.html#envoy-v3-api-field-extensions-filters-network-http-connection-manager-v3-httpconnectionmanager-tracing-custom-tags"><span class="std std-ref">custom_tags</span></a> 设置的定制 tag。</p></li>
<li><p>上游集群名字和地址。</p></li>
<li><p>HTTP 响应码。</p></li>
<li><p>GRPC 响应状态和信息（如果有）。</p></li>
<li><p>当 HTTP 状态码是 5xx 或者 GRPC 状态不是 “OK” 的时候出现的错误 tag。</p></li>
<li><p>跟踪系统的特定信息。</p></li>
</ul>
<p>Span 还有包含一个名称（或者操作），默认定义为被调用服务的服务名。当然，也可以在路由上使用 <a class="reference internal" href="../../../api-v3/config/route/v3/route_components.proto.html#envoy-v3-api-msg-config-route-v3-decorator"><span class="std std-ref">config.route.v3.Decorator</span></a> 来进行自定义。还可以使用 <a class="reference internal" href="../../../configuration/http/http_filters/router_filter.html#config-http-filters-router-x-envoy-decorator-operation"><span class="std std-ref">x-envoy-decorator-operation</span></a> Header 来重写名称。</p>
<p>Envoy 自动发送 Span 给跟踪采集器。多个 Span 会被揉和在一起使用一些共同的信息，比如全局唯一的请求 ID <a class="reference internal" href="../../../configuration/http/http_conn_man/headers.html#config-http-conn-man-headers-x-request-id"><span class="std std-ref">x-request-id</span></a> (LightStep) 或者跟踪 ID 配置（Zipkin 和 Datadog），当然这取决于跟踪采集器。</p>
<p>查看 <a class="reference internal" href="../../../api-v3/config/trace/v3/http_tracer.proto.html#envoy-v3-api-msg-config-trace-v3-tracing"><span class="std std-ref">v3 API reference</span></a> 来获取更多的关于在 Envoy 中设置跟踪的信息。</p>
</div>
<div class="section" id="baggage">
<h2>Baggage<a class="headerlink" href="#baggage" title="Permalink to this headline">¶</a></h2>
<p>Baggage 提供一种数据在整个跟踪过程中都可用的机制。尽管诸如标签之类的元数据被用来和带外收集器进行通信，但是 baggage 数据会被注入到实际的请求上下文中，
并且在请求持续的时间内对应用程序是可用的。这使得遍布在整个服务网格的元数据从请求的开始就是透明的，而无须依赖为了传递而修改特定的应用。
查看 <a class="reference external" href="https://opentracing.io/docs/overview/tags-logs-baggage/">OpenTracing 文档</a> 来了解更多关于 baggage 的信息。</p>
<p>对于设置和获取 baggage，跟踪器提供商有着不同的水平：</p>
<ul class="simple">
<li><p>Lightstep (以及其它任何兼容 OpenTracing 的追踪器) 能够读/写 baggage</p></li>
<li><p>Zipkin 支持至今还没有实现</p></li>
<li><p>X-Ray 和 OpenCensus 不支持 baggage</p></li>
</ul>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../security/security.html" class="btn btn-neutral float-right" title="安全" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="access_logging.html" class="btn btn-neutral float-left" title="访问日志" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2016-2020, Envoy Project Authors

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>