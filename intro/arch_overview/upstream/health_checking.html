

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>健康检查 &mdash; envoy 1.16.0-2109ae documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/envoy.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/sphinx_tabs/semantic-ui-2.4.1/segment.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/sphinx_tabs/semantic-ui-2.4.1/menu.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/sphinx_tabs/semantic-ui-2.4.1/tab.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/sphinx_tabs/tabs.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/copybutton.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
        <script src="../../../_static/clipboard.min.js"></script>
        <script src="../../../_static/copybutton.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="连接池" href="connection_pooling.html" />
    <link rel="prev" title="服务发现" href="service_discovery.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html">
          

          
            
            <img src="../../../_static/envoy-logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                1.16.0-2109ae
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../about_docs.html">关于文档</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../intro.html">介绍</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../what_is_envoy.html">Envoy 是什么？</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../arch_overview.html">架构概览</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../intro/intro.html">介绍</a></li>
<li class="toctree-l3"><a class="reference internal" href="../listeners/listeners_toc.html">监听器</a></li>
<li class="toctree-l3"><a class="reference internal" href="../http/http.html">HTTP</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="upstream.html">上游集群</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="cluster_manager.html">集群管理器</a></li>
<li class="toctree-l4"><a class="reference internal" href="service_discovery.html">服务发现</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">健康检查</a></li>
<li class="toctree-l4"><a class="reference internal" href="connection_pooling.html">连接池</a></li>
<li class="toctree-l4"><a class="reference internal" href="load_balancing/load_balancing.html">负载均衡</a></li>
<li class="toctree-l4"><a class="reference internal" href="aggregate_cluster.html">聚合集群</a></li>
<li class="toctree-l4"><a class="reference internal" href="outlier.html">异常点检测</a></li>
<li class="toctree-l4"><a class="reference internal" href="circuit_breaking.html">断路</a></li>
<li class="toctree-l4"><a class="reference internal" href="upstream_filters.html">Upstream network filters</a></li>
<li class="toctree-l4"><a class="reference internal" href="load_reporting_service.html">负载上报服务 (LRS)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../observability/observability.html">可观察性</a></li>
<li class="toctree-l3"><a class="reference internal" href="../security/security.html">安全</a></li>
<li class="toctree-l3"><a class="reference internal" href="../operations/operations.html">操作与配置</a></li>
<li class="toctree-l3"><a class="reference internal" href="../other_features/other_features.html">其他特性</a></li>
<li class="toctree-l3"><a class="reference internal" href="../other_protocols/other_protocols.html">其他协议</a></li>
<li class="toctree-l3"><a class="reference internal" href="../advanced/advanced.html">高级的</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../life_of_a_request.html">请求的生命周期</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../deployment_types/deployment_types.html">部署类型</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../getting_help.html">获取帮助</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../start/start.html">开始</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../install/install.html">构建和安装</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../version_history/version_history.html">Version history</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../configuration/configuration.html">配置参考</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../operations/operations.html">Operations and administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../extending/extending.html">Extending Envoy for custom use cases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/api.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/overview.html">FAQ</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">envoy</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../intro.html">介绍</a> &raquo;</li>
        
          <li><a href="../arch_overview.html">架构概览</a> &raquo;</li>
        
          <li><a href="upstream.html">上游集群</a> &raquo;</li>
        
      <li>健康检查</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../_sources/intro/arch_overview/upstream/health_checking.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="arch-overview-health-checking">
<span id="id1"></span><h1>健康检查<a class="headerlink" href="#arch-overview-health-checking" title="Permalink to this headline">¶</a></h1>
<p>可以在每个上游集群的基础上 <a class="reference internal" href="../../../configuration/upstream/cluster_manager/cluster_hc.html#config-cluster-manager-cluster-hc"><span class="std std-ref">配置</span></a> 主动健康检查。如 <a class="reference internal" href="service_discovery.html#arch-overview-service-discovery"><span class="std std-ref">服务发现</span></a> 部分所述，主动健康检查和 EDS 服务发现类型是并行协作的。 但是，在其他情况下，即使使用其他服务发现类型，也期望有主动健康检查。Envoy 支持三种不同类型的运行健康检查以及各种设置（检查时间间隔、主机不健康标记为故障、主机健康时标记为成功等）：</p>
<ul class="simple">
<li><p><strong>HTTP</strong>: 在 HTTP 运行健康检查期间，Envoy 将向上游主机发送HTTP请求。 默认情况下，如果主机运行状况良好，则期望 200 响应。 预期的响应代码是 <a class="reference internal" href="../../../api-v3/config/core/v3/health_check.proto.html#envoy-v3-api-msg-config-core-v3-healthcheck-httphealthcheck"><span class="std std-ref">可配置</span></a> 的。 如果上游主机希望立即通知下游主机不再向其转发流量，则可以返回 503 。</p></li>
<li><p><strong>L3/L4</strong>: 在 L3/L4 健康检查期间，Envoy 会向上游主机发送一个可配置的字节缓冲区。如果主机被认为是健康的，字节缓冲区在响应中会被显示出来。Envoy 还支持仅连接 L3/L4 健康检查。</p></li>
<li><p><strong>Redis</strong>: Envoy 将发送 Redis PING 命令并期望 PONG 响应。如果上游 Redis 服务器使用 PONG 以外的任何其他响应命令，则会导致健康检查失败。或者，Envoy 可以在用户指定的键上执行 EXISTS。如果键不存在，则认为它是合格的健康检查。这允许用户通过将指定的键设置为任意值来标记 Redis 实例以进行维护直至流量耗尽。请参阅 <a class="reference internal" href="../../../api-v3/config/health_checker/redis/v2/redis.proto.html#envoy-v3-api-msg-config-health-checker-redis-v2-redis"><span class="std std-ref">redis_key</span></a> 。</p></li>
</ul>
<p>健康检查是运行在为集群指定的传输套接字之上的。这意味着，如果集群使用启用了 TLS 的传输套接字，则健康检查也将在 TLS 之上运行。 可以指定用于健康检查连接的 <a class="reference internal" href="../../../api-v3/config/core/v3/health_check.proto.html#envoy-v3-api-msg-config-core-v3-healthcheck-tlsoptions"><span class="std std-ref">TLS 选项</span></a> ，如果对应的上游使用基于 ALPN 的 :ref:FilterChainMatch &lt;envoy_v3_api_msg_config.listener.v3.FilterChainMatch&gt;，健康检查与数据连接使用不同的协议，这将是非常有用的。</p>
<div class="section" id="arch-overview-per-cluster-health-check-config">
<span id="id2"></span><h2>每个集群成员健康检查配置<a class="headerlink" href="#arch-overview-per-cluster-health-check-config" title="Permalink to this headline">¶</a></h2>
<p>如果为上游集群配置了主动健康检查，则可以通过在 <a class="reference internal" href="../../../api-v3/config/endpoint/v3/endpoint.proto.html#envoy-v3-api-msg-config-endpoint-v3-clusterloadassignment"><span class="std std-ref">ClusterLoadAssignment</span></a> 中每个已定义的 <a class="reference internal" href="../../../api-v3/config/endpoint/v3/endpoint_components.proto.html#envoy-v3-api-msg-config-endpoint-v3-localitylbendpoints"><span class="std std-ref">LocalityLbEndpoints</span></a> 的 <a class="reference internal" href="../../../api-v3/config/endpoint/v3/endpoint_components.proto.html#envoy-v3-api-msg-config-endpoint-v3-lbendpoint"><span class="std std-ref">LbEndpoint</span></a> 的 <a class="reference internal" href="../../../api-v3/config/endpoint/v3/endpoint_components.proto.html#envoy-v3-api-msg-config-endpoint-v3-endpoint"><span class="std std-ref">Endpoint</span></a> 中设置 <a class="reference internal" href="../../../api-v3/config/endpoint/v3/endpoint_components.proto.html#envoy-v3-api-msg-config-endpoint-v3-endpoint-healthcheckconfig"><span class="std std-ref">HealthCheckConfig</span></a> 来为每个注册成员指定特定的附加配置。</p>
<p>以下示例为设置运行 <a class="reference internal" href="../../../api-v3/config/endpoint/v3/endpoint_components.proto.html#envoy-v3-api-msg-config-endpoint-v3-endpoint-healthcheckconfig"><span class="std std-ref">健康检查配置</span></a> 以设置 <a class="reference internal" href="../../../api-v3/config/endpoint/v3/endpoint_components.proto.html#envoy-v3-api-msg-config-endpoint-v3-endpoint"><span class="std std-ref">集群成员</span></a> 可选运行健康检查的 <a class="reference internal" href="../../../api-v3/config/endpoint/v3/endpoint_components.proto.html#envoy-v3-api-field-config-endpoint-v3-endpoint-healthcheckconfig-port-value"><span class="std std-ref">端口</span></a></p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">load_assignment</span><span class="p">:</span>
  <span class="nt">endpoints</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">lb_endpoints</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">endpoint</span><span class="p">:</span>
        <span class="nt">health_check_config</span><span class="p">:</span>
          <span class="nt">port_value</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">8080</span>
        <span class="nt">address</span><span class="p">:</span>
          <span class="nt">socket_address</span><span class="p">:</span>
            <span class="nt">address</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">localhost</span>
            <span class="nt">port_value</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">80</span>
</pre></div>
</div>
</div>
<div class="section" id="arch-overview-health-check-logging">
<span id="id3"></span><h2>健康检查事件日志<a class="headerlink" href="#arch-overview-health-check-logging" title="Permalink to this headline">¶</a></h2>
<p>Envoy 可以通过在 <a class="reference internal" href="../../../api-v3/config/core/v3/health_check.proto.html#envoy-v3-api-field-config-core-v3-healthcheck-event-log-path"><span class="std std-ref">HealthCheck 配置</span></a> 中指定日志文件路径，选择性地生成包含弹出和添加事件的 per-healthchecker 日志。日志结构为 <a class="reference internal" href="../../../api-v3/data/core/v3/health_check_event.proto.html#envoy-v3-api-msg-data-core-v3-healthcheckevent"><span class="std std-ref">HealthCheckEvent 消息</span></a> 的 JSON dumps。</p>
<p>通过将 <a class="reference internal" href="../../../api-v3/config/core/v3/health_check.proto.html#envoy-v3-api-field-config-core-v3-healthcheck-always-log-health-check-failures"><span class="std std-ref">always_log_health_check_failures
标志</span></a> 设置为 true，来配置 Envoy 以记录所有健康检查失败事件。</p>
</div>
<div class="section" id="id4">
<h2>被动的健康检查<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h2>
<p>Envoy 还支持通过 <a class="reference internal" href="outlier.html#arch-overview-outlier-detection"><span class="std std-ref">异常检测</span></a> 进行被动健康检查。</p>
</div>
<div class="section" id="id5">
<h2>连接池交互<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h2>
<p>请参阅 <a class="reference internal" href="connection_pooling.html#arch-overview-conn-pool-health-checking"><span class="std std-ref">此处</span></a> 了解更多信息。</p>
</div>
<div class="section" id="http">
<span id="arch-overview-health-checking-filter"></span><h2>HTTP 健康检查过滤器<a class="headerlink" href="#http" title="Permalink to this headline">¶</a></h2>
<p>当部署 Envoy 网格并在集群之间进行主动健康检查时，会生成大量健康检查流量。Envoy 包含一个 HTTP 健康检查过滤器，可以安装在配置的 HTTP 监听器中。这个过滤器有几种不同的操作模式：</p>
<ul class="simple">
<li><p><strong>不通过</strong>: 健康检查请求永远不会被传递给本地服务。Envoy 会根据当前服务器的排空状态来返回 200 或 503。</p></li>
<li><p><strong>不通过，根据上游集群健康状况计算</strong>: 在此模式下，运行健康检查过滤器将返回 200 或 503，具体取决于一个或多个上游集群中是否至少有 <a class="reference internal" href="../../../api-v3/extensions/filters/http/health_check/v3/health_check.proto.html#envoy-v3-api-field-extensions-filters-http-health-check-v3-healthcheck-cluster-min-healthy-percentages"><span class="std std-ref">指定百分比</span></a> 的服务器可用(运行状况+降级)。(但是，如果 Envoy 服务器处于排空状态，则无论上游集群运行状况如何，它都将使用 503 响应。)</p></li>
<li><p><strong>通过</strong>: 在此模式下，Envoy 会将每个健康检查请求传递给本地服务。根据该服务的健康状态返回 200 或 503。</p></li>
<li><p><strong>通过缓存传递</strong>: 在此模式下，Envoy 会将健康检查请求传递给本地服务，但会将结果缓存一段时间。在缓存有效期内，随后的健康检查请求会直接返回从缓存的获取的值。缓存过期后，后续的健康检查请求将传递给本地服务。操作大型网格时，推荐使用此操作模式。Envoy 会保持健康检查的连接，所以健康检查请求对 Envoy 自身的耗费很小。因此，这种操作模式对每个上游主机的健康状态生成了最终一致的视图，而没有用大量的健康检查请求压倒本地服务。</p></li>
</ul>
<p>进一步阅读:</p>
<ul class="simple">
<li><p>健康检查过滤器 <a class="reference internal" href="../../../configuration/http/http_filters/health_check_filter.html#config-http-filters-health-check"><span class="std std-ref">配置</span></a>。</p></li>
<li><p><a class="reference internal" href="../../../operations/admin.html#operations-admin-interface-healthcheck-fail"><span class="std std-ref">/healthcheck/fail</span></a> 管理端点。</p></li>
<li><p><a class="reference internal" href="../../../operations/admin.html#operations-admin-interface-healthcheck-ok"><span class="std std-ref">/healthcheck/ok</span></a> 管理端点。</p></li>
</ul>
</div>
<div class="section" id="id6">
<h2>主动健康检查快速失败<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h2>
<p>在使用主动健康检查和被动健康检查( <a class="reference internal" href="outlier.html#arch-overview-outlier-detection"><span class="std std-ref">异常检测</span></a> )时，通常使用较长的运行健康检查间隔来避免大量的主动健康检查流量。在这种情况下，当使用 <a class="reference internal" href="../../../configuration/http/http_filters/router_filter.html#config-http-filters-router-x-envoy-immediate-health-check-fail"><span class="std std-ref">x-envoy-immediate-health-check-fail</span></a> 管理端点来尽快排空上游主机仍旧是非常有效的手段。为了支持这一点， <a class="reference internal" href="../../../configuration/http/http_filters/router_filter.html#config-http-filters-router"><span class="std std-ref">路由器过滤器</span></a> 将响应 <a class="reference internal" href="../../../configuration/http/http_filters/router_filter.html#config-http-filters-router-x-envoy-immediate-health-check-fail"><span class="std std-ref">x-envoy-immediate-health-check-fail</span></a> 头。如果上游主机设置了此头，Envoy 会立即将该主机标记为主动健康检查失败。注意，只有在主机集群 <a class="reference internal" href="../../../configuration/upstream/cluster_manager/cluster_hc.html#config-cluster-manager-cluster-hc"><span class="std std-ref">配置</span></a> 了主动健康检查时才会发生这种情况。如果通过 <a class="reference internal" href="../../../operations/admin.html#operations-admin-interface-healthcheck-fail"><span class="std std-ref">/healthcheck/fail</span></a> 管理端点将 Envoy 标记为失败，则 <a class="reference internal" href="../../../configuration/http/http_filters/health_check_filter.html#config-http-filters-health-check"><span class="std std-ref">健康检查筛选器</span></a> 将自动设置此头。</p>
</div>
<div class="section" id="arch-overview-health-checking-identity">
<span id="id7"></span><h2>健康检查识别<a class="headerlink" href="#arch-overview-health-checking-identity" title="Permalink to this headline">¶</a></h2>
<p>只验证上游主机是否响应特定的健康检查 URL 并不一定意味着上游主机有效。例如，当在自动扩缩容的云环境或容器环境中使用最终一致的服务发现时，主机可能会消失，但随后其他主机以相同的 IP 地址返回，这是有可能的。解决此问题的一个办法是针对每种服务类型都有不同的 HTTP 健康检查 URL。该方法的缺点是整体配置会变得更加复杂，因为每个健康检查 URL 都是完全自定义的。</p>
<p>Envoy HTTP 健康检查器支持 <a class="reference internal" href="../../../api-v3/config/core/v3/health_check.proto.html#envoy-v3-api-field-config-core-v3-healthcheck-httphealthcheck-service-name-matcher"><span class="std std-ref">service_name_matcher</span></a> 选项。如果设置了此选项，健康检查程序还会将 <em>x-envoy-upstream-healthchecked-cluster</em>
响应头部的值与 <em>service_name_matcher</em> 进行比较。如果值不匹配，则健康检查不通过。上游健康检查过滤器会将 <em>x-envoy-upstream-healthchecked-cluster</em> 附加到响应头。这个值由 <a class="reference internal" href="../../../operations/cli.html#cmdoption-service-cluster"><code class="xref std std-option docutils literal notranslate"><span class="pre">--service-cluster</span></code></a> 命令行选项决定。</p>
</div>
<div class="section" id="arch-overview-health-checking-degraded">
<span id="id8"></span><h2>健康状况下降<a class="headerlink" href="#arch-overview-health-checking-degraded" title="Permalink to this headline">¶</a></h2>
<p>使用 HTTP 健康检查器时，上游主机可以返回 <code class="docutils literal notranslate"><span class="pre">x-envoy-degraded</span></code> 以通知健康检查器该主机已降级。 请参阅 <a class="reference internal" href="load_balancing/degraded.html#arch-overview-load-balancing-degraded"><span class="std std-ref">此处</span></a> 以了解这如何影响负载均衡。</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="connection_pooling.html" class="btn btn-neutral float-right" title="连接池" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="service_discovery.html" class="btn btn-neutral float-left" title="服务发现" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2016-2020, Envoy Project Authors

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>