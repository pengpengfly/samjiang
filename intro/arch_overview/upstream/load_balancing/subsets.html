

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>负载均衡器子集 &mdash; envoy 1.16.0-7245b2 documentation</title>
  

  
  <link rel="stylesheet" href="../../../../_static/css/envoy.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/sphinx_tabs/semantic-ui-2.4.1/segment.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/sphinx_tabs/semantic-ui-2.4.1/menu.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/sphinx_tabs/semantic-ui-2.4.1/tab.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/sphinx_tabs/tabs.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/copybutton.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../../../_static/favicon.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/doctools.js"></script>
        <script src="../../../../_static/language_data.js"></script>
        <script src="../../../../_static/clipboard.min.js"></script>
        <script src="../../../../_static/copybutton.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link rel="next" title="聚合集群" href="../aggregate_cluster.html" />
    <link rel="prev" title="区域感知路由" href="zone_aware.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html">
          

          
            
            <img src="../../../../_static/envoy-logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                1.16.0-7245b2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../../about_docs.html">关于文档</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../../intro.html">介绍</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../../what_is_envoy.html">Envoy 是什么？</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../arch_overview.html">架构概览</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../../intro/intro.html">介绍</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../listeners/listeners_toc.html">监听器</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../http/http.html">HTTP</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="../upstream.html">上游集群</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="../cluster_manager.html">集群管理器</a></li>
<li class="toctree-l4"><a class="reference internal" href="../service_discovery.html">服务发现</a></li>
<li class="toctree-l4"><a class="reference internal" href="../health_checking.html">健康检查</a></li>
<li class="toctree-l4"><a class="reference internal" href="../connection_pooling.html">连接池</a></li>
<li class="toctree-l4 current"><a class="reference internal" href="load_balancing.html">负载均衡</a></li>
<li class="toctree-l4"><a class="reference internal" href="../aggregate_cluster.html">聚合集群</a></li>
<li class="toctree-l4"><a class="reference internal" href="../outlier.html">异常点检测</a></li>
<li class="toctree-l4"><a class="reference internal" href="../circuit_breaking.html">断路</a></li>
<li class="toctree-l4"><a class="reference internal" href="../upstream_filters.html">Upstream network filters</a></li>
<li class="toctree-l4"><a class="reference internal" href="../load_reporting_service.html">负载上报服务 (LRS)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../observability/observability.html">可观察性</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../security/security.html">安全</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../operations/operations.html">操作与配置</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../other_features/other_features.html">其他特性</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../other_protocols/other_protocols.html">其他协议</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../advanced/advanced.html">高级的</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../life_of_a_request.html">请求的生命周期</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../deployment_types/deployment_types.html">部署类型</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../getting_help.html">获取帮助</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../start/start.html">开始</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../install/install.html">构建和安装</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../version_history/version_history.html">Version history</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../configuration/configuration.html">配置参考</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../operations/operations.html">Operations and administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../extending/extending.html">Extending Envoy for custom use cases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/api.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../faq/overview.html">FAQ</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">envoy</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../../intro.html">介绍</a> &raquo;</li>
        
          <li><a href="../../arch_overview.html">架构概览</a> &raquo;</li>
        
          <li><a href="../upstream.html">上游集群</a> &raquo;</li>
        
          <li><a href="load_balancing.html">负载均衡</a> &raquo;</li>
        
      <li>负载均衡器子集</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../../_sources/intro/arch_overview/upstream/load_balancing/subsets.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="arch-overview-load-balancer-subsets">
<span id="id1"></span><h1>负载均衡器子集<a class="headerlink" href="#arch-overview-load-balancer-subsets" title="Permalink to this headline">¶</a></h1>
<p>Envoy 可被配置为根据主机所带的元数据将上游集群内的主机分为若干子集。然后，路由可以指定主机必须匹配的元数据，以便被负载平衡器选择，并可选择回退到预先设定的某些主机（包括任何主机）。</p>
<p>负载均衡器子集使用集群指定的负载均衡策略。由于事先不知道上游主机，所以子集可能无法使用原始目的地策略。子集与区域感知路由兼容，但要注意子集的使用很容易违反上述的最小主机匹配条件。</p>
<p>如果子集是 <a class="reference internal" href="../../../../api-v3/config/cluster/v3/cluster.proto.html#envoy-v3-api-field-config-cluster-v3-cluster-lb-subset-config"><span class="std std-ref">已配置的</span></a>，并且路由指定没有元数据或没有匹配元数据的子集存在，则负载均衡器子集启动其后备策略。默认策略是 <code class="docutils literal notranslate"><span class="pre">NO_FALLBACK</span></code>，在这种情况下，请求会失败，就像集群没有主机一样。相反，<code class="docutils literal notranslate"><span class="pre">ANY_ENDPOINT</span></code> 后备策略会在集群中的所有主机上进行负载均衡，而不考虑主机元数据。最后，<code class="docutils literal notranslate"><span class="pre">DEFAULT_SUBSET</span></code> 后备策略会使负载均衡在符合特定元数据集的主机之间进行。通过特定的子集选择器配置，可以覆盖后备策略。</p>
<p>子集必须被预定义，以使负载均衡器子集能够有效地选择正确的主机子集。每个定义都是一组键，这就转化为零个或多个子集。从概念上讲，每台主机如果具有定义中所有键的元数据值，就会被添加到特定于其键值对的子集中。如果没有主机可以匹配到所有键，则该定义就不会产生子集。可以提供多个定义，如果一个主机与多个定义相匹配，它可以出现在多个子集中。</p>
<p>在路由过程中，路由的元数据匹配配置被用来寻找特定的子集。如果有一个子集与路由指定的键和值完全一致，则使用该子集进行负载均衡。否则，将使用后备策略。因此，集群的子集配置必须包含一个与给定路由具有相同键的定义，才能实现子集负载均衡。</p>
<p>子集可以被配置为每个子集中只有一台主机，这可以用于类似于 <a class="reference internal" href="load_balancers.html#arch-overview-load-balancing-types-maglev"><span class="std std-ref">Maglev</span></a> 或 <a class="reference internal" href="load_balancers.html#arch-overview-load-balancing-types-ring-hash"><span class="std std-ref">哈希环</span></a> 的用例，例如基于 Cookie 的负载均衡，这类场景通常需要实现即使在新主机添加到集群后也要选择相同的主机。如果启用了 <a class="reference internal" href="../../../../api-v3/config/cluster/v3/cluster.proto.html#envoy-v3-api-field-config-cluster-v3-cluster-lbsubsetconfig-lbsubsetselector-single-host-per-subset"><span class="std std-ref">single_host_per_subset</span></a>，则端点配置更改可能会使用较少的 CPU。</p>
<p>只有在使用 <a class="reference internal" href="../../../../api-v3/config/endpoint/v3/endpoint.proto.html#envoy-v3-api-msg-config-endpoint-v3-clusterloadassignment"><span class="std std-ref">ClusterLoadAssignments</span></a> 定义主机时，才支持主机元数据。ClusterLoadAssignments 可通过 EDS 或集群的 <a class="reference internal" href="../../../../api-v3/config/cluster/v3/cluster.proto.html#envoy-v3-api-field-config-cluster-v3-cluster-load-assignment"><span class="std std-ref">load_assignment</span></a> 字段获得。用于子集负载均衡的主机元数据必须放在过滤器名称 <code class="docutils literal notranslate"><span class="pre">&quot;envoy.lb&quot;</span></code> 下。同样，路由元数据匹配条件使用 <code class="docutils literal notranslate"><span class="pre">&quot;envoy.lb&quot;</span></code> 过滤器名称。主机元数据可以是分层的（例如，顶层键的值可以是一个结构化的值或列表），但负载均衡器子集只比较顶层键和值。因此，当使用结构化值时，只有当主机的元数据中出现相同的结构化值时，路由的匹配条件才会匹配成功。</p>
<p>最后，需要注意的是，负载均衡器子集是无法使用 <a class="reference internal" href="../../../../api-v3/config/cluster/v3/cluster.proto.html#envoy-v3-api-enum-value-config-cluster-v3-cluster-lbpolicy-cluster-provided"><span class="std std-ref">CLUSTER_PROVIDED</span></a> 负载均衡器策略的。</p>
<div class="section" id="id2">
<h2>示例<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p>我们将在示例中使用简单的元数据，所有的值都是字符串。假定在一个集群中有以下的主机：</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 21%" />
<col style="width: 79%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>主机</p></th>
<th class="head"><p>元数据</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>host1</p></td>
<td><p>v: 1.0, stage: prod</p></td>
</tr>
<tr class="row-odd"><td><p>host2</p></td>
<td><p>v: 1.0, stage: prod</p></td>
</tr>
<tr class="row-even"><td><p>host3</p></td>
<td><p>v: 1.1, stage: canary</p></td>
</tr>
<tr class="row-odd"><td><p>host4</p></td>
<td><p>v: 1.2-pre, stage: dev</p></td>
</tr>
</tbody>
</table>
<p>集群可以像这样启用负载均衡器子集：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">---</span>
<span class="n">name</span><span class="p">:</span> <span class="n">cluster</span><span class="o">-</span><span class="n">name</span>
<span class="nb">type</span><span class="p">:</span> <span class="n">EDS</span>
<span class="n">eds_cluster_config</span><span class="p">:</span>
  <span class="n">eds_config</span><span class="p">:</span>
    <span class="n">path</span><span class="p">:</span> <span class="s1">&#39;.../eds.conf&#39;</span>
<span class="n">connect_timeout</span><span class="p">:</span>
  <span class="n">seconds</span><span class="p">:</span> <span class="mi">10</span>
<span class="n">lb_policy</span><span class="p">:</span> <span class="n">LEAST_REQUEST</span>
<span class="n">lb_subset_config</span><span class="p">:</span>
  <span class="n">fallback_policy</span><span class="p">:</span> <span class="n">DEFAULT_SUBSET</span>
  <span class="n">default_subset</span><span class="p">:</span>
    <span class="n">stage</span><span class="p">:</span> <span class="n">prod</span>
  <span class="n">subset_selectors</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">keys</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">v</span>
    <span class="o">-</span> <span class="n">stage</span>
  <span class="o">-</span> <span class="n">keys</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">stage</span>
    <span class="n">fallback_policy</span><span class="p">:</span> <span class="n">NO_FALLBACK</span>
</pre></div>
</div>
<p>下表描述了一些路由和它们应用到集群的结果。通常，匹配标准将用于匹配请求的特定方面，如路径或请求头信息的路由。</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 21%" />
<col style="width: 12%" />
<col style="width: 67%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>匹配条件</p></th>
<th class="head"><p>选择目标</p></th>
<th class="head"><p>选择原因</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>stage: canary</p></td>
<td><p>host3</p></td>
<td><p>匹配到主机子集</p></td>
</tr>
<tr class="row-odd"><td><p>v: 1.2-pre, stage: dev</p></td>
<td><p>host4</p></td>
<td><p>匹配到主机子集</p></td>
</tr>
<tr class="row-even"><td><p>v: 1.0</p></td>
<td><p>host1, host2</p></td>
<td><p>后备：没有子集可以单独匹配键值 “v”</p></td>
</tr>
<tr class="row-odd"><td><p>other: x</p></td>
<td><p>host1, host2</p></td>
<td><p>后备：没有子集可以匹配到键值  “other”</p></td>
</tr>
<tr class="row-even"><td><p>(none)</p></td>
<td><p>host1, host2</p></td>
<td><p>后备：没有子集匹配请求</p></td>
</tr>
<tr class="row-odd"><td><p>stage: test</p></td>
<td><p>空集群</p></td>
<td><p>后备策略被覆盖为 “NO_FALLBACK”</p></td>
</tr>
</tbody>
</table>
<p>元数据匹配条件也可以在路由的加权集群上指定。所选加权集群的元数据匹配条件整合并覆盖路由的匹配条件：</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 28%" />
<col style="width: 43%" />
<col style="width: 29%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>路由匹配条件</p></th>
<th class="head"><p>加权集群匹配条件</p></th>
<th class="head"><p>最终匹配条件</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>stage: canary</p></td>
<td><p>stage: prod</p></td>
<td><p>stage: prod</p></td>
</tr>
<tr class="row-odd"><td><p>v: 1.0</p></td>
<td><p>stage: prod</p></td>
<td><p>v: 1.0, stage: prod</p></td>
</tr>
<tr class="row-even"><td><p>v: 1.0, stage: prod</p></td>
<td><p>stage: canary</p></td>
<td><p>v: 1.0, stage: canary</p></td>
</tr>
<tr class="row-odd"><td><p>v: 1.0, stage: prod</p></td>
<td><p>v: 1.1, stage: canary</p></td>
<td><p>v: 1.1, stage: canary</p></td>
</tr>
<tr class="row-even"><td><p>(none)</p></td>
<td><p>v: 1.0</p></td>
<td><p>v: 1.0</p></td>
</tr>
<tr class="row-odd"><td><p>v: 1.0</p></td>
<td><p>(none)</p></td>
<td><p>v: 1.0</p></td>
</tr>
</tbody>
</table>
<div class="section" id="id3">
<h3>带元数据的主机示例<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<p>一个含有主机元数据的 EDS <code class="docutils literal notranslate"><span class="pre">LbEndpoint</span></code>：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">---</span>
<span class="n">endpoint</span><span class="p">:</span>
  <span class="n">address</span><span class="p">:</span>
    <span class="n">socket_address</span><span class="p">:</span>
      <span class="n">protocol</span><span class="p">:</span> <span class="n">TCP</span>
      <span class="n">address</span><span class="p">:</span> <span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span>
      <span class="n">port_value</span><span class="p">:</span> <span class="mi">8888</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">filter_metadata</span><span class="p">:</span>
    <span class="n">envoy</span><span class="o">.</span><span class="n">lb</span><span class="p">:</span>
      <span class="n">version</span><span class="p">:</span> <span class="s1">&#39;1.0&#39;</span>
      <span class="n">stage</span><span class="p">:</span> <span class="s1">&#39;prod&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="id4">
<h3>带元数据匹配条件的路径示例<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<p>一个具备元数据匹配条件的 RDS <code class="docutils literal notranslate"><span class="pre">Route</span></code>：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">---</span>
<span class="n">match</span><span class="p">:</span>
  <span class="n">prefix</span><span class="p">:</span> <span class="o">/</span>
<span class="n">route</span><span class="p">:</span>
  <span class="n">cluster</span><span class="p">:</span> <span class="n">cluster</span><span class="o">-</span><span class="n">name</span>
  <span class="n">metadata_match</span><span class="p">:</span>
    <span class="n">filter_metadata</span><span class="p">:</span>
      <span class="n">envoy</span><span class="o">.</span><span class="n">lb</span><span class="p">:</span>
        <span class="n">version</span><span class="p">:</span> <span class="s1">&#39;1.0&#39;</span>
        <span class="n">stage</span><span class="p">:</span> <span class="s1">&#39;prod&#39;</span>
</pre></div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../aggregate_cluster.html" class="btn btn-neutral float-right" title="聚合集群" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="zone_aware.html" class="btn btn-neutral float-left" title="区域感知路由" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2016-2020, Envoy Project Authors

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>